<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Player Tool N√¢ng C·∫•p</title>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f9;
        }
        h1, h2 {
            color: #333;
        }
        #fileInput {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            display: block;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 15px;
        }
        #playlist {
            list-style: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
        }
        #playlist li {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
            word-break: break-all;
        }
        #playlist li:last-child {
            border-bottom: none;
        }
        #playlist li:hover {
            background-color: #e9e9e9;
        }
        .active-track {
            background-color: #007bff !important;
            color: white;
            font-weight: bold;
        }
        #playerContainer {
            margin-top: 15px;
            position: relative;
        }
        #playerContainer audio, #playerContainer video {
            width: 100%;
            height: auto;
            display: block;
        }
        #controls button {
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>üé¨ Web Player Tool N√¢ng C·∫•p</h1>

    <input 
        type="file" 
        id="fileInput" 
        accept="audio/*, video/*, .m3u" 
        multiple 
        webkitdirectory
    >

    <hr>

    <h2>Tr√¨nh ph√°t</h2>
    <div id="playerContainer">
        </div>
    <div id="controls">
        <button id="prevBtn" disabled>‚èÆÔ∏è B√†i tr∆∞·ªõc</button>
        <button id="nextBtn" disabled>‚è≠Ô∏è B√†i ti·∫øp theo</button>
    </div>
    <p id="currentTrack">Ch∆∞a c√≥ b√†i n√†o ƒëang ph√°t.</p>

    <hr>

    <h2>Danh s√°ch ph√°t</h2>
    <ul id="playlist">
        <li id="empty-message">Vui l√≤ng ch·ªçn **th∆∞ m·ª•c** ho·∫∑c **file .m3u** ƒë·ªÉ th√™m v√†o danh s√°ch.</li>
    </ul>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('fileInput');
            const playlistElement = document.getElementById('playlist');
            const playerContainer = document.getElementById('playerContainer');
            const currentTrackDisplay = document.getElementById('currentTrack');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            let allFiles = {}; // L∆∞u tr·ªØ t·∫•t c·∫£ c√°c File object trong th∆∞ m·ª•c ƒë√£ ch·ªçn (key: relativePath)
            let trackList = []; // Danh s√°ch c√°c b√†i h√°t s·∫Ω ƒë∆∞·ª£c ph√°t (theo th·ª© t·ª± .m3u n·∫øu c√≥)
            let currentTrackIndex = -1;

            // --- 0. Kh·ªüi t·∫°o Tr√¨nh ph√°t (Audio/Video) ---
            function createPlayerElement(isAudo = true) {
                playerContainer.innerHTML = ''; // X√≥a tr√¨nh ph√°t c≈©
                const player = isAudo ? document.createElement('audio') : document.createElement('video');
                player.id = 'mediaPlayer';
                player.controls = true;
                player.autoplay = true;
                
                // G·∫Øn s·ª± ki·ªán chuy·ªÉn b√†i t·ª± ƒë·ªông
                player.addEventListener('ended', playNextTrack);
                
                playerContainer.appendChild(player);
                return player;
            }
            // Kh·ªüi t·∫°o tr√¨nh ph√°t m·∫∑c ƒë·ªãnh l√† Audio
            let mediaPlayer = createPlayerElement(true);

            // --- 1. X·ª≠ l√Ω khi ng∆∞·ªùi d√πng ch·ªçn file/th∆∞ m·ª•c ---
            fileInput.addEventListener('change', (event) => {
                const files = event.target.files;
                if (files.length > 0) {
                    
                    // 1.1. Reset v√† x√¢y d·ª±ng l·∫°i allFiles
                    allFiles = {};
                    let m3uFile = null;

                    // L·ªçc file v√† l∆∞u v√†o allFiles
                    for (const file of files) {
                        const relativePath = file.webkitRelativePath || file.name;
                        allFiles[relativePath] = file;

                        if (file.name.toLowerCase().endsWith('.m3u')) {
                            // ∆Øu ti√™n s·ª≠ d·ª•ng file .m3u ƒë·∫ßu ti√™n ƒë∆∞·ª£c t√¨m th·∫•y
                            if (!m3uFile) m3uFile = file;
                        }
                    }
                    
                    // 1.2. X√°c ƒë·ªãnh trackList
                    if (m3uFile) {
                        readM3U(m3uFile);
                    } else {
                        // N·∫øu kh√¥ng c√≥ M3U, t·∫°o trackList t·ª´ t·∫•t c·∫£ c√°c file media
                        trackList = Object.keys(allFiles)
                                        .filter(path => !path.toLowerCase().endsWith('.m3u') && 
                                                        (allFiles[path].type.startsWith('audio/') || allFiles[path].type.startsWith('video/')))
                                        .map(path => allFiles[path]);
                        updatePlaylistUI();
                        // T·ª± ƒë·ªông ph√°t b√†i ƒë·∫ßu ti√™n
                        if (trackList.length > 0) playTrack(0);
                    }
                }
            });

            // --- 2. ƒê·ªçc v√† x·ª≠ l√Ω file M3U ---
            function readM3U(m3uFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    const lines = content.split('\n');
                    
                    trackList = [];
                    // L·∫•y th∆∞ m·ª•c g·ªëc (n∆°i ch·ª©a file .m3u)
                    const m3uDir = m3uFile.webkitRelativePath ? m3uFile.webkitRelativePath.substring(0, m3uFile.webkitRelativePath.lastIndexOf('/')) : '';

                    for (const line of lines) {
                        // B·ªè qua d√≤ng comment v√† d√≤ng Extinf (m·ªü r·ªông)
                        if (line.trim() === '' || line.startsWith('#')) continue;

                        let trackPath = line.trim();
                        // N·∫øu ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi (v√≠ d·ª•: ../Nhac/file.mp3), th√¨ c·∫ßn gi·∫£i quy·∫øt
                        // ·ªû ƒë√¢y ta gi·∫£ ƒë·ªãnh c√°c file trong m3u c√≥ ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi so v·ªõi th∆∞ m·ª•c g·ªëc ƒë√£ ch·ªçn.
                        
                        // X√¢y d·ª±ng ƒë∆∞·ªùng d·∫´n tuy·ªát ƒë·ªëi trong allFiles (key)
                        let fullPathInFiles = trackPath;
                        if (!trackPath.includes('/')) {
                            // Gi·∫£ ƒë·ªãnh n·∫øu kh√¥ng c√≥ th∆∞ m·ª•c con, th√¨ file n·∫±m c√πng c·∫•p v·ªõi th∆∞ m·ª•c g·ªëc
                            fullPathInFiles = (m3uDir ? m3uDir + '/' : '') + trackPath;
                        }
                        
                        // T√¨m file trong danh s√°ch allFiles ƒë√£ thu th·∫≠p
                        const file = allFiles[fullPathInFiles] || allFiles[trackPath] || 
                                     Object.values(allFiles).find(f => f.name.toLowerCase() === trackPath.substring(trackPath.lastIndexOf('/') + 1).toLowerCase());
                        
                        if (file) {
                            trackList.push(file);
                        }
                    }

                    updatePlaylistUI();
                    if (trackList.length > 0) playTrack(0);
                };
                reader.readAsText(m3uFile);
            }

            // --- 3. C·∫≠p nh·∫≠t giao di·ªán Playlist ---
            function updatePlaylistUI() {
                playlistElement.innerHTML = '';
                if (trackList.length === 0) {
                    playlistElement.innerHTML = '<li id="empty-message">Kh√¥ng t√¨m th·∫•y file nh·∫°c/video h·ª£p l·ªá.</li>';
                    nextBtn.disabled = true;
                    prevBtn.disabled = true;
                    return;
                }

                trackList.forEach((file, index) => {
                    const li = document.createElement('li');
                    const trackName = file.webkitRelativePath || file.name;
                    li.textContent = trackName; 
                    li.dataset.index = index; 
                    
                    li.addEventListener('click', () => playTrack(index));
                    playlistElement.appendChild(li);
                });
            }

            // --- 4. H√†m ph√°t nh·∫°c/video ch√≠nh ---
            function playTrack(index) {
                if (index >= 0 && index < trackList.length) {
                    currentTrackIndex = index;
                    const file = trackList[index];

                    // X·ª≠ l√Ω Audio/Video
                    const isVideo = file.type.startsWith('video/');
                    const isAudio = file.type.startsWith('audio/');
                    
                    // N·∫øu lo·∫°i file kh√°c v·ªõi tr√¨nh ph√°t hi·ªán t·∫°i, t·∫°o l·∫°i tr√¨nh ph√°t
                    if ((isVideo && mediaPlayer.tagName !== 'VIDEO') || (isAudio && mediaPlayer.tagName !== 'AUDIO')) {
                        mediaPlayer = createPlayerElement(isAudio);
                    } else if (mediaPlayer.tagName !== 'AUDIO' && mediaPlayer.tagName !== 'VIDEO') {
                        // Tr∆∞·ªùng h·ª£p ƒë·∫∑c bi·ªát khi m·ªõi load trang v√† ch∆∞a c√≥ tr√¨nh ph√°t
                        mediaPlayer = createPlayerElement(isAudio);
                    }
                    
                    const fileURL = URL.createObjectURL(file);
                    
                    mediaPlayer.src = fileURL;
                    mediaPlayer.load();
                    mediaPlayer.play().catch(error => {
                        console.error("L·ªói khi c·ªë g·∫Øng ph√°t:", error);
                        currentTrackDisplay.innerHTML = `‚ñ∂Ô∏è ${file.name} - (Click n√∫t Play tr√™n tr√¨nh ph√°t)`;
                    });

                    // C·∫≠p nh·∫≠t th√¥ng tin v√† highlight
                    const trackNameDisplay = file.webkitRelativePath || file.name;
                    currentTrackDisplay.innerHTML = `**${isVideo ? 'üì∫ ƒêang ph√°t Video:' : 'üé∂ ƒêang ph√°t Nh·∫°c:'}** ${trackNameDisplay}`;
                    highlightActiveTrack(index);
                    updateControls();
                }
            }

            // --- 5. ƒêi·ªÅu khi·ªÉn chuy·ªÉn b√†i ---
            function playNextTrack() {
                if (currentTrackIndex < trackList.length - 1) {
                    playTrack(currentTrackIndex + 1);
                } else {
                    currentTrackDisplay.innerHTML = "‚úÖ **Danh s√°ch ph√°t ƒë√£ ho√†n th√†nh.**";
                    highlightActiveTrack(-1);
                    updateControls();
                }
            }

            function playPrevTrack() {
                if (currentTrackIndex > 0) {
                    playTrack(currentTrackIndex - 1);
                }
            }

            function updateControls() {
                prevBtn.disabled = currentTrackIndex <= 0;
                nextBtn.disabled = currentTrackIndex >= trackList.length - 1 || trackList.length === 0;
            }
            
            // G·∫Øn s·ª± ki·ªán cho n√∫t ƒëi·ªÅu khi·ªÉn
            nextBtn.addEventListener('click', playNextTrack);
            prevBtn.addEventListener('click', playPrevTrack);


            // --- 6. Highlight b√†i ƒëang ph√°t ---
            function highlightActiveTrack(index) {
                const items = playlistElement.querySelectorAll('li');
                items.forEach(item => {
                    item.classList.remove('active-track');
                });

                if (index !== -1) {
                    const activeItem = playlistElement.querySelector(`li[data-index="${index}"]`);
                    if (activeItem) {
                        activeItem.classList.add('active-track');
                        activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }
            }
        });
    </script>
</body>
</html>
