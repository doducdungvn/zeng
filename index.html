<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Báo cáo thu tiền - 8.ZENG™</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    /* --- BẢNG MÀU MODERN TEAL --- */
    :root {
        --primary-color: #1abc9c; /* Teal */
        --primary-dark: #16a085; /* Darker Teal */
        --secondary-color: #bdc3c7; /* Silver */
        --secondary-dark: #95a5a6; /* Darker Silver */
        --header-bg: #34495e; /* Wet Asphalt */
        --header-text: #ecf0f1; /* Clouds */
        --body-bg: #ecf0f1; /* Clouds */
        --container-bg: #ffffff; /* White */
        --text-color: #2c3e50; /* Midnight Blue */
        --text-light: #7f8c8d; /* Asbestos */
        --border-color: #dfe6e9; /* Light Grey */
        --success-color: #2ecc71; /* Emerald */
        --danger-color: #e74c3c; /* Alizarin */
        --warning-color: #f39c12; /* Orange */
        --info-color: #3498db; /* Peter River */
        --logo-color: #e67e22; /* Carrot - Màu đỏ ánh vàng */

        --light-red-bg: #fdecea; /* Very Light Red */
        --success-light-bg: #eafaf1;
        --info-light-bg: #eaf2f8;
        --neutral-light-bg: #f8f9f9;
        
        --modal-overlay-bg: rgba(44, 62, 80, 0.7); 
    }

    /* --- CÀI ĐẶT CHUNG --- */
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        margin: 0;
        padding: 15px;
        background-color: var(--body-bg);
        color: var(--text-color);
        font-size: 16px;
        line-height: 1.6;
    }
    .page { max-width: 600px; margin: 20px auto; padding: 15px; background-color: var(--container-bg); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    h2, h3 { text-align: center; color: var(--header-bg); margin-bottom: 0.8em; }
    h2 { font-size: 26px; font-weight: 600; }
    h3 { font-size: 20px; font-weight: 500; } 
    h4 { margin-top: 0; text-align: center; color: var(--text-color); font-weight: 500;}
    .report-date { text-align:center; font-weight: normal; margin-top: -12px; margin-bottom: 16px; color: var(--text-light); line-height: 1.5; } /* THAY ĐỔI: Thêm line-height */

    /* --- CSS CHO LOGO ZENG™ ANIMATED (PHIÊN BẢN MỚI) --- */
    .simple-animated-logo {
        text-align: center; margin-bottom: 15px; margin-top: 10px;
        font-size: 32px; font-weight: 700; 
        color: var(--logo-color); /* Màu khởi đầu */
        overflow: hidden; 
        /* Thêm transition cho việc đổi màu mượt mà */
        transition: color 0.5s ease-in-out;
    }
    .main-page-logo {
        font-size: 24px; margin-top: 5px; margin-bottom: 10px;
    }

    .simple-animated-logo span {
        opacity: 0; /* Ẩn các ký tự ban đầu */
        display: inline-block; 
        transform: translateY(15px); /* Bắt đầu ở dưới */
        /* Dùng transition thay vì animation */
        transition: opacity 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94), 
                    transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    
    /* Xóa các @keyframes và animation-delay */

    .simple-animated-logo .tm {
        font-size: 0.5em; vertical-align: super; margin-left: 2px;
        font-weight: normal; color: var(--text-light); /* Màu TM riêng */
    }
    /* --- KẾT THÚC CSS LOGO --- */


    .controls-panel { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--container-bg); }
    label { font-weight: 500; color: var(--text-color); }
    input[type="text"], input[type="file"], input[type="number"], select, button, textarea { padding: 12px 15px; border-radius: 6px; border: 1px solid var(--border-color); width: 100%; box-sizing: border-box; font-size: 16px; transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
    input:focus, textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(26, 188, 156, 0.2); outline: none; }
    
    /* === THÊM MỚI: Style cho textarea bị vô hiệu hóa === */
    textarea:disabled {
        background-color: var(--neutral-light-bg);
        color: var(--text-light);
        cursor: not-allowed;
    }

    input[type="file"] { background-color: #fdfdfe; cursor: pointer; }
    input[type="file"]:hover { border-color: var(--secondary-dark); }
    input[type="file"].loaded { background-color: var(--success-light-bg); border-color: var(--success-color); }
    button { cursor: pointer; background: var(--primary-color); color: white; border: none; transition: background-color 0.2s, transform 0.1s; font-weight: 500; padding: 12px 20px; text-align: center; }
    button:hover { background-color: var(--primary-dark); filter: brightness(110%); }
    button:active { transform: scale(0.98); filter: brightness(90%); }
    button.secondary { background-color: var(--secondary-color); color: var(--text-color); }
    button.secondary:hover { background-color: var(--secondary-dark); filter: brightness(105%);}
    button.success { background-color: var(--success-color); }
    button.success:hover { background-color: #27ae60; } 
    button.danger { background-color: var(--danger-color); }
    button.danger:hover { background-color: #c0392b; } 
    button.warning { background-color: var(--warning-color); }
    button.warning:hover { background-color: #e67e22; } 
    
    /* CẬP NHẬT THANH NAV CHÍNH */
    .main-nav { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
    .summary-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px; } /* THAY ĐỔI: margin-bottom -> margin-top */
    
    .main-nav button { background-color: var(--secondary-color); color: var(--text-color); }
    .main-nav button:hover { background-color: var(--secondary-dark); }
    .main-nav button.active { background-color: var(--primary-color); color: white; }
    .main-nav button.active:hover { background-color: var(--primary-dark); }
    /* Nút nạp lại nổi bật */
    .main-nav button.warning { font-weight: 600; }

    table { border-collapse: collapse; width: 100%; margin: 1px auto; background: var(--container-bg); box-shadow: 0 2px 8px rgba(0,0,0,0.06); border-radius: 6px; overflow: hidden; }
    th, td { border: 1px solid var(--border-color); padding: 10px 12px; text-align: center; vertical-align: middle; }
    th { background: var(--header-bg); color: var(--header-text); font-size: 16px; font-weight: 500; }
    tr.group-start-row td { border-top: 2px solid var(--secondary-dark) !important; }
    .report-table { table-layout: fixed; }
    .report-table th { width: 33.33%; }
    .report-table tbody td { font-weight: 500; font-size: 20px; }
    .header { font-weight: 500; background: var(--neutral-light-bg); }
    .so-so { font-size: 32px; font-weight: 600; color: var(--warning-color); vertical-align: middle; }
    #tongCongRow { background-color: #FFC107; color: var(--text-color); font-weight: 600 !important;} /* THAY ĐỔI: Đổi màu nền sang vàng cam */
    #mainBonusRow { background-color: var(--success-color); color: #ffffff; } /* THAY ĐỔI: Nền xanh lá, chữ trắng */
    #mainBonusRow td { font-weight: 600; }
    .added-ticket-row { background-color: #ffffff; } /* THAY ĐỔI: Đổi nền thành màu trắng */
    
    /* === THAY ĐỔI: Chỉnh dòng bán vé đậm và giống các dòng khác === */
    .added-ticket-row td:first-child { 
        /* color: #2980b9; */ /* Bỏ màu xanh để dùng màu chữ mặc định */
        /* font-size: 15px; */ /* Bỏ cỡ chữ riêng để dùng cỡ chữ của bảng (20px) */
        font-weight: 500; /* Đổi thành 500 để đậm bằng các dòng khác */
    } 
    
    .bang-chu-cell { text-align: left !important; font-style: italic; padding-left: 15px !important; font-size: 10px; font-weight: normal; color: var(--text-light); }
    
    /* THAY ĐỔI: Đổi màu nền dòng "Bằng chữ" sang trắng */
    #bangChuRow, #bangChuRow td {
        background: #ffffff !important;
    }

    .ticket-type-selector { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 8px; }
    .ticket-type-selector label { display: flex; align-items: center; gap: 5px; font-weight: normal; cursor: pointer; }
    .copyright { text-align: center; margin-top: 25px; font-size: 14px; color: var(--text-light); }
    #actionButtonContainer, #actionChoices { display: none; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
    #actionChoices { grid-column: 1 / -1; margin-top: 15px; }
    .dynamic-input { width: 100%; border: none; font-weight: 600; text-align: center; background: transparent; font-size: 17px; padding: 5px; resize: none; overflow-y: hidden; }
    .dynamic-input::placeholder { color: var(--secondary-dark); font-weight: normal; }
    textarea.dynamic-input { text-align: right; } 
    #summaryTableContainer { margin-top: 10px; overflow-x: auto; }
    #summaryTableContainer table { width: auto; } /* CHO PHÉP BẢNG RỘNG HƠN */
    #summaryTableContainer table th { position: sticky; top: 0; z-index: 1; }
    /* NGĂN XUỐNG DÒNG TRONG BẢNG TỔNG KẾT */
    #summaryTableContainer th, 
    #summaryTableContainer td {
        white-space: nowrap;
    }
    #summaryTableContainer tfoot tr { font-weight: 600; } /* THAY ĐỔI: Xóa màu nền/chữ chung */
    /* THAY ĐỔI: Thêm quy tắc mới cho ô tfoot */
    #summaryTableContainer tfoot tr td {
        background-color: var(--header-bg);
        color: var(--header-text);
    }
    /* === THÊM MỚI: Làm đậm số sổ đại lý (cột 2) === */
    #summaryTableContainer tbody td:nth-child(2) {
        font-weight: 500;
    }
    .negative-value { color: var(--danger-color); }

    /* --- CSS MỚI: Cỡ chữ Tổng Tiền (Bảng Tổng Kết) --- */
    #summaryTableContainer tfoot .final-amount-positive,
    #summaryTableContainer tfoot .final-amount-negative {
        /* font-size: 21px; */ /* <--- ĐÃ XÓA THEO YÊU CẦU */
        font-weight: 700; /* Đậm hơn các tổng khác (600) */
    }

    /* === THAY ĐỔI: Chỉnh nền dòng "Phải nộp" (đỏ) và "Lấy về" (xanh) === */
    /* .final-amount-positive, .final-amount-negative { background-color: var(--light-red-bg) !important; } */ /* Tắt dòng này */
    .final-amount-positive { 
        background-color: var(--danger-color) !important; /* Nền đỏ */
        color: #ffffff !important; /* Chữ trắng */
    }
    .final-amount-negative { 
        background-color: var(--success-color) !important; /* Nền xanh */
        color: var(--danger-color) !important; /* THAY ĐỔI: Chữ đỏ */
    }
    tr.final-amount-positive td, tr.final-amount-negative td { font-size: 30px !important; font-weight: 600; color: inherit !important; padding: 15px 12px !important; }
    
    .inline-form { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .inline-form > input { flex: 1 1 100%; } /* THAY ĐỔI: Input luôn chiếm 100% */
    .inline-form > button { flex: 0 1 auto; white-space: nowrap; padding: 12px 15px; } 
    .home-actions, .form-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    
    /* === THÊM MỚI: Grid cho các nút của Báo cáo chi tiết === */
    .report-actions-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 10px; /* Thêm khoảng cách với input bên trên */
    }

    /* === THÊM MỚI: Grid cho bộ lọc trên PC === */
    .filter-grid-container {
        display: grid;
        grid-template-columns: 1fr; /* 1-col default (mobile) */
        gap: 15px;
    }
    .filter-column {
        display: flex;
        flex-direction: column;
        gap: 10px; /* Khoảng cách giữa label, input, button */
    }
    /* === KẾT THÚC THÊM MỚI === */

    /* === THÊM MỚI: CSS CHO BỘ LỌC DOANH SỐ === */
    .revenue-filter-grid {
        display: grid;
        grid-template-columns: 1fr; /* Mobile: 1 cột */
        gap: 15px;
    }

    .revenue-filter-buttons {
        display: grid;
        grid-template-columns: 2fr 1fr; /* Mobile: Nút Lọc to hơn */
        gap: 10px;
    }
    /* === KẾT THÚC THÊM MỚI === */


    .manual-grid { display: grid; grid-template-columns: auto 1fr; gap: 15px; align-items: center; }
    .manual-grid label { text-align: right; font-size: 15px; }
    .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: var(--modal-overlay-bg); padding-top: 60px; animation: fadeIn 0.3s ease-out; }
    .modal-content { background-color: var(--container-bg); margin: auto; padding: 25px; border: 1px solid var(--border-color); width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); position: relative; animation: slideIn 0.3s ease-out; }
    .modal-close-btn { color: var(--text-light); position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; }
    .modal-close-btn:hover, .modal-close-btn:focus { color: var(--danger-color); text-decoration: none; }
    @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }
    @keyframes slideIn { from {transform: translateY(-50px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
    #notification-area { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
    .notification { padding: 12px 20px; border-radius: 6px; color: white; font-size: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.15); opacity: 0; transform: translateX(100%); transition: opacity 0.3s ease-out, transform 0.3s ease-out; }
    .notification.show { opacity: 1; transform: translateX(0); }
    .notification.success { background-color: var(--success-color); }
    .notification.error { background-color: var(--danger-color); }
    .notification.info { background-color: var(--info-color); }
    #loading-indicator { display: none; position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background-color: var(--header-bg); color: var(--header-text); padding: 8px 15px; border-radius: 4px; font-size: 14px; z-index: 2100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); animation: fadeIn 0.3s; }
    .context-note { font-size: 14px; color: var(--text-light); text-align: center; margin-top: -10px; margin-bottom: 15px; font-style: italic; }
    
    /* CSS cho modal nạp lại file */
    #reloadModal .controls-panel {
        padding-top: 10px;
        box-shadow: none;
        border: none;
    }

    /* === THAY ĐỔI: CSS cho nút cuộn === */
    #scrollToTopBtn, #scrollToBottomBtn {
        display: none; /* Ẩn ban đầu */
        position: fixed;
        right: 20px;
        z-index: 1001;
        border: none;
        outline: none;
        background-color: var(--header-bg);
        color: white;
        cursor: pointer;
        padding: 0; /* Xóa padding */
        border-radius: 50%; /* Làm tròn */
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        
        /* THAY ĐỔI: Chỉnh kích thước nhỏ lại */
        width: 40px; 
        height: 40px;
        font-size: 16px;
        line-height: 40px; /* Căn giữa icon */
        text-align: center;
    }
    
    #scrollToTopBtn {
        bottom: 20px;
    }

    #scrollToBottomBtn {
        top: 20px; /* THÊM MỚI: Vị trí nút cuộn xuống */
    }
    
    #scrollToTopBtn.show, #scrollToBottomBtn.show {
        display: block;
        opacity: 0.8;
    }

    #scrollToTopBtn:hover, #scrollToBottomBtn:hover {
        opacity: 1;
        background-color: var(--primary-dark);
    }
    /* === KẾT THÚC THAY ĐỔI === */
    
    /* === THÊM MỚI: CSS cho Tiêu đề Báo cáo === */
    #summaryTitle {
        font-size: 18px; /* Nhỏ hơn h3 (20px) */
    }
    .region-name {
        display: inline-block; /* Ngăn ngắt dòng giữa chừng */
        color: var(--primary-dark);
        font-weight: 600;
    }
    /* === KẾT THÚC THÊM MỚI === */


    /* === THÊM MỚI: Media Query cho bố cục PC của bộ lọc === */
    @media (min-width: 768px) {
        .filter-grid-container {
            grid-template-columns: 1fr 1fr; /* 2-col trên PC */
        }
        .filter-column {
            height: 100%; /* Đảm bảo các cột có chiều cao bằng nhau */
        }
        .filter-column textarea {
            flex-grow: 1; /* Giúp textarea lấp đầy không gian */
        }
        .filter-column .inline-form {
            margin-top: auto; /* Đẩy mục chọn xuống dưới cùng của cột 2 */
        }
        /* === THÊM MỚI VÀO BLOCK HIỆN TẠI === */
        .revenue-filter-grid {
            grid-template-columns: 1.5fr 1fr 1fr; /* PC: 3 cột (Sắp xếp, Từ, Đến) */
            gap: 15px;
            align-items: flex-end; /* Căn đáy */
        }

        .revenue-filter-buttons {
            grid-column: 1 / -1; /* Hàng mới, span full */
            margin-top: 15px; /* Khoảng cách với hàng trên */
            grid-template-columns: 3fr 1fr; /* PC: Nút Lọc vẫn to hơn */
        }
        /* === KẾT THÚC THÊM MỚI === */
    }


    @media (max-width: 768px) {
        body { margin: 0; padding: 10px; font-size: 4vw; -webkit-text-size-adjust: 100%; }
        .page { padding: 10px; margin: 10px auto; }
        h2 { font-size: 6vw; } h3 { font-size: 5vw; } label { font-size: 4vw; }
        .simple-animated-logo { font-size: 8vw; } 
        .main-page-logo { font-size: 6vw; margin-bottom: 15px; } /* Logo nhỏ hơn trên mobile */
        input, button, textarea { padding: 10px 12px; font-size: 4vw; }
        th, td { padding: 8px; font-size: 4vw; word-break: break-word; }
        .so-so { font-size: 6vw; word-break: break-all; }
        tr.final-amount-positive td, tr.final-amount-negative td { font-size: 6.8vw !important; padding: 11px 7px !important; }
        
        /* === THAY ĐỔI: Chỉnh cỡ chữ "Phải nộp" trên di động === */
        tr.final-amount-positive td#ketQuaLabel {
            font-size: 6vw !important;
            white-space: nowrap;
        }
        
        /* === THÊM MỚI: CSS Tiêu đề cho Mobile === */
        #summaryTitle {
            font-size: 4.5vw; /* Nhỏ hơn h3 (5vw) */
        }
        /* === KẾT THÚC THÊM MỚI === */

        .bang-chu-cell { font-size: 3vw !important; }
        .copyright { font-size: 3vw; }
        
        /* === THAY ĐỔI: Xóa cỡ chữ riêng cho dòng bán vé trên di động === */
        /* .added-ticket-row td:first-child { font-size: 3.8vw; } */ /* Xóa bỏ để dùng cỡ chữ chung 4vw */
        
        .dynamic-input { font-size: 4.2vw !important; }
        .manual-grid { grid-template-columns: 1fr; }
        .manual-grid label { text-align: left; }
        .modal-content { width: 95%; padding: 20px; }
        .modal-close-btn { top: 8px; right: 12px; font-size: 24px; }
        #notification-area { top: 10px; right: 10px; }
        .notification { font-size: 3.8vw; padding: 10px 15px;}
        /* XÓA BỎ: .inline-form > button { flex-basis: 48%; } */

        /* --- CHỈNH KÍCH CỠ BẢNG TỔNG KẾT (ĐIỆN THOẠI) --- */
        #summaryTableContainer th,
        #summaryTableContainer td {
            font-size: 2vw; /* Giảm cỡ chữ (mặc định 3.8vw) */
            padding: 3px;     /* Giảm đệm (mặc định 8px) */
        }

        
        /* --- CSS MỚI: Cỡ chữ Tổng Tiền (Mobile) --- */
        #summaryTableContainer tfoot .final-amount-positive,
        #summaryTableContainer tfoot .final-amount-negative {
            font-size: 2vw; /* <--- THAY ĐỔI: Bằng với các tổng khác */
            font-weight: 700; /* Đậm hơn các tổng khác (600) */
            padding: 3px;     /* Giảm đệm (giống các ô khác) */
        }
        /* Cỡ chữ cho nút Lọc D.Số trên mobile */
        .revenue-filter-buttons button {
            font-size: 3.8vw; /* Đảm bảo cỡ chữ nhất quán */
        }
    }
    @media (min-width: 769px) { #mainPage { max-width: 1200px; } }
    @media print { body * { visibility: hidden; } #summaryTableContainer, #summaryTableContainer * { visibility: visible; } #summaryTableContainer { position: absolute; left: 0; top: 0; width: 100%; overflow: visible; } table { font-size: 10pt; } th, td { padding: 4px; } button, a, #notification-area, .modal-overlay, #loading-indicator { display: none !important; } }
  </style>
</head>
<body>

  <div id="notification-area"></div>
  
  <div id="loading-indicator">Đang xử lý...</div>

  <div id="homePage" class="page">
    <div class="simple-animated-logo">
        <span class="logo-char-1">Z</span>
        <span class="logo-char-2">E</span>
        <span class="logo-char-3">N</span>
        <span class="logo-char-4">G</span>
        <span class="logo-char-5 tm">™</span>
      <span class="logo-char-6 8">8</span>
    </div>
    <h2>Báo cáo Thu Tiền</h2>
    <div class="controls-panel">
        <label for="excelFile1">Chọn file Biểu 31 (Lô tô):</label>
        <input type="file" id="excelFile1" accept=".xls,.xlsx">
        
        <label for="excelFile2">Chọn file Biểu 35 (XSKT - Tùy chọn):</label>
        <input type="file" id="excelFile2" accept=".xls,.xlsx">
        
        <div class="home-actions">
            <button id="btnShowManualReport" class="warning">Thêm Báo cáo</button>
            <button id="btnLoadData" class="success">Nạp dữ liệu</button>
        </div>
    </div>
    <div class="copyright">
        © 2025 ZENG FINANCE
    </div>
  </div>
  
  <div id="mainPage" class="page" style="display: none;">
    <div class="simple-animated-logo main-page-logo">
        <span class="logo-char-1">Z</span>
        <span class="logo-char-2">E</span>
        <span class="logo-char-3">N</span>
        <span class="logo-char-4">G</span>
        <span class="logo-char-5 tm">™</span>
    </div>

    <div class="main-nav">
        <button id="navSummary" class="active">Báo cáo Tổng hợp</button>
        <button id="navReport">Báo cáo Chi tiết</button> <button id="navSell">Bán thêm vé</button>
        <button id="navReload" class="warning">Nạp lại Excel</button>
    </div>

    <div id="summarySection" class="main-section">
        
        <div class="controls-panel" style="margin-bottom: 15px; padding: 15px;">
            <div class="filter-grid-container">
                <div class="filter-column">
                    <label for="regionDefinitionsInput">Định nghĩa vùng (Mỗi vùng 1 dòng):</label>
                    <textarea id="regionDefinitionsInput" rows="4" placeholder="Ví dụ:&#10;huyện Ý Yên: 550_599+650_699+6999&#10;huyện Vụ Bản: 200_299+350_450"></textarea>
                    <button id="btnSaveRegions" class="success">Lưu Định nghĩa</button>
                </div>
                
                <div class="filter-column">
                    <label for="regionSelect">Chọn Đơn vị:</label>
                    <div class="inline-form" style="flex-wrap: nowrap;"> <select id="regionSelect" style="flex-grow: 1;">
                            <option value="all">--- Tất cả ---</option>
                            </select>
                        <button id="btnClearSummaryFilter" class="secondary" style="flex-grow: 0; margin-left: 10px;">Xoá lọc</button>
                    </div>
                </div>
            </div>
            <hr style="border-color: var(--border-color); margin: 20px 0 15px 0; border-style: dashed;">
            
            <div class="revenue-filter-grid">
                <div class="filter-column">
                    <label for="sortSelect">Sắp xếp theo:</label>
                    <select id="sortSelect">
                        <option value="default">Mặc định (Số sổ)</option>
                        <option value="revenue_desc">Doanh số (Cao đến Thấp)</option>
                        <option value="revenue_asc">Doanh số (Thấp đến Cao)</option>
                    </select>
                </div>
                
                <div class="filter-column">
                    <label for="minRevenueInput">Doanh số từ (nghìn):</label>
                    <input type="text" id="minRevenueInput" class="manual-currency" inputmode="numeric" placeholder="Ví dụ: 100 (cho 100.000)">
                </div>
                
                <div class="filter-column">
                    <label for="maxRevenueInput">Doanh số đến (nghìn):</label>
                    <input type="text" id="maxRevenueInput" class="manual-currency" inputmode="numeric" placeholder="Để trống = Tối đa">
                </div>

                <div class="filter-column revenue-filter-buttons">
                    <button id="btnApplyRevenueFilter" class="success">Lọc / Sắp xếp</button>
                    <button id="btnClearRevenueFilter" class="secondary">Xoá lọc D.Số</button>
                </div>
            </div>
            </div>
        <h3 id="summaryTitle">Bảng Báo Cáo Tổng Hợp:</h3>
        <h4 id="summaryDate" class="report-date"></h4>
        
        <div id="summaryTableContainer"></div>
        <div class="summary-actions">
            <button id="btnCopySummary" class="success">Copy Ảnh</button>
            <button id="btnSaveSummary" class="secondary">Tải ảnh</button>
        </div>
    </div>

    <div id="reportSection" class="main-section" style="display: none;">
        <h3>Tạo Báo Cáo Chi Tiết</h3>
        <div class="controls-panel">
            <label for="soSoInput">Nhập số sổ (ví dụ: 550):</label>
            <div class="inline-form">
                <input type="text" id="soSoInput" inputmode="numeric" placeholder="Nhập số sổ...">
            </div>
            <div class="report-actions-grid">
                <button id="btnCreateReport">Tạo báo cáo</button>
                <button id="btnShowManualReport_inline" class="warning">Thêm Báo cáo</button>
            </div>
            </div>
        
        <div id="reportContainer"></div>
        <div id="actionButtonContainer">
            <button id="btnCopyReport">Copy Ảnh</button>
            <button id="toggleChoicesBtn" class="secondary">Thêm tiền Thưởng/Nợ</button>
            <div id="actionChoices"></div>
        </div>
    </div>

    <div id="sellSection" class="main-section" style="display: none;">
        <h3>Bán thêm Vé (Thêm vào Báo cáo chi tiết)</h3>
        <p class="context-note">Vé sẽ được thêm vào báo cáo chi tiết đang được hiển thị.</p>
        <div id="sellTicketControls" class="controls-panel">
            <div>
                <label>Loại hình:</label>
                <div class="ticket-type-selector">
                    <label><input type="radio" name="sellTicketType" value="xo-so" checked> Xổ số</label>
                    <label><input type="radio" name="sellTicketType" value="ve-boc"> Vé bóc</label>
                    <label><input type="radio" name="sellTicketType" value="custom-name"> Tự nhập tên</label>
                </div>
                <input type="text" id="customTicketName" placeholder="Nhập tên loại hình..." style="display:none; margin-top: 5px;">
            </div>
            <div>
                <label>Giá bán:</label>
                <div class="ticket-type-selector">
                    <label><input type="radio" name="sellPrice" value="10000" checked> 10.000</label>
                    <label><input type="radio" name="sellPrice" value="20000"> 20.000</label>
                    <label><input type="radio" name="sellPrice" value="5000"> 5.000</label>
                    <label><input type="radio" name="sellPrice" value="custom-price"> Tự nhập giá</label>
                </div>
                <input type="text" id="customTicketPrice" inputmode="numeric" placeholder="Nhập giá bán..." style="display:none; margin-top: 5px;">
            </div>
            <div>
                <label>Hoa hồng:</label>
                <div class="ticket-type-selector">
                    <label><input type="radio" name="commissionRate" value="0.10" checked> 10%</label>
                    <label><input type="radio" name="commissionRate" value="0.12"> 12%</label>
                    <label><input type="radio" name="commissionRate" value="custom-commission"> Tự nhập %</label>
                </div>
                <input type="number" id="customCommissionPercent" placeholder="Nhập % hoa hồng (ví dụ: 15)" style="display:none; margin-top: 5px;" min="0">
            </div>
            <div>
                <label for="sellQuantityInput">Số lượng:</label>
                <input type="number" id="sellQuantityInput" placeholder="Nhập số lượng vé..." min="0">
            </div>
            <button id="btnAddTicket" class="success">Thêm vé vào báo cáo</button>
        </div>
    </div>
  </div>

   <div id="manualInputModal" class="modal-overlay">
     <div class="modal-content">
       <span id="closeModalBtn" class="modal-close-btn">&times;</span>
       <div id="manualReportFormContent" class="controls-panel"> 
           <h4 style="margin-top:0; text-align:center;">Thêm Báo Cáo Thủ Công</h4>
           <div class="manual-grid">
               <label for="manualAgentName">Tên Đại Lý:</label>
               <input type="text" id="manualAgentName" placeholder="Tự nhập...">
               <label for="manualDateRange">Thời gian:</label>
               <input type="text" id="manualDateRange" placeholder="Tự nhập...">
               <label for="manualLotoDB">Lô tô Đặc biệt:</label>
               <input type="text" id="manualLotoDB" inputmode="numeric" class="manual-currency" placeholder="Nhập doanh thu...">
               <label for="manualLoCap">Lô cặp:</label>
               <input type="text" id="manualLoCap" inputmode="numeric" class="manual-currency" placeholder="Nhập doanh thu...">
               <label for="manualC227">2/27:</label>
               <input type="text" id="manualC227" inputmode="numeric" class="manual-currency" placeholder="Nhập doanh thu...">
               <label for="manualC323">3/23:</label>
               <input type="text" id="manualC323" inputmode="numeric" class="manual-currency" placeholder="Nhập doanh thu...">
               <label for="manualThuong">Thưởng:</label>
               <input type="text" id="manualThuong" inputmode="numeric" class="manual-currency" placeholder="Nhập tiền thưởng...">
           </div>
           <div class="form-actions">
               <button id="btnClearManualReport" class="secondary">Xoá</button>
               <button id="btnCreateManualReport" class="success">Thêm</button>
           </div>
       </div>
     </div>
   </div>

   <div id="imagePreviewModal" class="modal-overlay">
     <div class="modal-content">
       <span id="closePreviewModalBtn" class="modal-close-btn">&times;</span>
       <h4 style="margin-top:0; text-align:center;">Sao chép Ảnh Báo cáo</h4>
       <p style="text-align: center; color: var(--text-light); margin-top: -10px;">
           Nhấn chuột phải vào ảnh dưới đây và chọn "Sao chép hình ảnh":
       </p>
       <img id="imagePreviewHolder" src="" alt="Bản xem trước báo cáo" style="width: 100%; border: 1px solid var(--border-color); border-radius: 4px; user-select: auto; -webkit-user-select: auto;">
     </div>
   </div>

    <div id="reloadModal" class="modal-overlay">
      <div class="modal-content">
        <span id="closeReloadModalBtn" class="modal-close-btn">&times;</span>
        <div id="reloadFormContent" class="controls-panel" style="border: none; box-shadow: none; padding: 10px 0;"> 
            <h4 style="margin-top:0; text-align:center;">Nạp lại File Excel</h4>
            
            <label for="reloadFile1">Chọn file Biểu 31 (Lô tô):</label>
            <input type="file" id="reloadFile1" accept=".xls,.xlsx">
            
            <label for="reloadFile2">Chọn file Biểu 35 (XSKT - Tùy chọn):</label>
            <input type="file" id="reloadFile2" accept=".xls,.xlsx">
            
            <button id="btnReloadSubmit" class="success" style="margin-top: 15px;">Nạp</button>
        </div>
      </div>
    </div>

    <div id="passwordModal" class="modal-overlay">
      <div class="modal-content">
        <span id="closePasswordModalBtn" class="modal-close-btn">&times;</span>
        <div class="controls-panel" style="border: none; box-shadow: none; padding: 10px 0;"> 
            <h4 style="margin-top:0; text-align:center;">Yêu cầu Mật khẩu</h4>
            <label for="passwordInput">Vui lòng nhập mật khẩu để chỉnh sửa:</label>
            <input type="password" id="passwordInput" style="font-size: 18px;">
            <div class="form-actions" style="margin-top: 15px;">
                <button id="cancelPasswordBtn" class="secondary">Huỷ</button>
                <button id="btnSubmitPassword" class="success">Xác nhận</button>
            </div>
        </div>
      </div>
    </div>

  <button id="scrollToTopBtn" title="Cuộn lên đầu trang">&#9650;</button>
  <button id="scrollToBottomBtn" title="Cuộn xuống dưới">&#9660;</button>

  <script>
    'use strict';

    (function() {
        // ===== MODULE-LEVEL VARIABLES & STATE =====
        let excelData1 = [];
        let excelData2 = [];
        let dateRangeText = "Chưa có ngày";
        let regionDefinitions = {}; // <-- THÊM MỚI: Để lưu định nghĩa vùng
        let isRegionLocked = false; // <-- THÊM MỚI: Trạng thái khoá

        const state = {
            currentSoSo: null, baseTongDT: 0, baseTongHH: 0, baseThuong: 0,
            extraBonus: 0, extraDebt: 0, addedTickets: [], accountCodes: new Set()
        };

        // ===== DOM ELEMENT REFERENCES =====
        const DOM = {
            homePage: document.getElementById('homePage'), mainPage: document.getElementById('mainPage'),
            excelFile1: document.getElementById('excelFile1'), excelFile2: document.getElementById('excelFile2'),
            btnLoadData: document.getElementById('btnLoadData'), navSummary: document.getElementById('navSummary'),
            navReport: document.getElementById('navReport'), navSell: document.getElementById('navSell'),
            summarySection: document.getElementById('summarySection'), reportSection: document.getElementById('reportSection'),
            sellSection: document.getElementById('sellSection'), summaryTableContainer: document.getElementById('summaryTableContainer'),
            summaryDate: document.getElementById('summaryDate'), soSoInput: document.getElementById('soSoInput'),
            btnCreateReport: document.getElementById('btnCreateReport'), reportContainer: document.getElementById('reportContainer'),
            actionButtonContainer: document.getElementById('actionButtonContainer'), btnCopySummary: document.getElementById('btnCopySummary'),
            btnSaveSummary: document.getElementById('btnSaveSummary'), // <-- ĐÃ THAY ĐỔI
            /* XÓA BỎ: btnToggleSummaryView */
            btnCopyReport: document.getElementById('btnCopyReport'),
            toggleChoicesBtn: document.getElementById('toggleChoicesBtn'), actionChoices: document.getElementById('actionChoices'),
            btnAddTicket: document.getElementById('btnAddTicket'), sellQuantityInput: document.getElementById('sellQuantityInput'),
            btnShowManualReport: document.getElementById('btnShowManualReport'), btnShowManualReport_inline: document.getElementById('btnShowManualReport_inline'),
            manualInputModal: document.getElementById('manualInputModal'),
            btnCreateManualReport: document.getElementById('btnCreateManualReport'), 
            btnClearManualReport: document.getElementById('btnClearManualReport'), 
            manualAgentName: document.getElementById('manualAgentName'), 
            manualDateRange: document.getElementById('manualDateRange'), 
            manualLotoDB: document.getElementById('manualLotoDB'), 
            manualLoCap: document.getElementById('manualLoCap'), 
            manualC227: document.getElementById('manualC227'), 
            manualC323: document.getElementById('manualC323'), 
            manualThuong: document.getElementById('manualThuong'), 
            sellTicketTypeRadios: document.querySelectorAll('input[name="sellTicketType"]'), sellPriceRadios: document.querySelectorAll('input[name="sellPrice"]'),
            commissionRateRadios: document.querySelectorAll('input[name="commissionRate"]'), customTicketName: document.getElementById('customTicketName'),
            customTicketPrice: document.getElementById('customTicketPrice'), customCommissionPercent: document.getElementById('customCommissionPercent'),
            closeModalBtn: document.getElementById('closeModalBtn'),
            notificationArea: document.getElementById('notification-area'),
            loadingIndicator: document.getElementById('loading-indicator'),
            imagePreviewModal: document.getElementById('imagePreviewModal'),
            closePreviewModalBtn: document.getElementById('closePreviewModalBtn'),
            imagePreviewHolder: document.getElementById('imagePreviewHolder'),
            navReload: document.getElementById('navReload'),
            reloadModal: document.getElementById('reloadModal'),
            closeReloadModalBtn: document.getElementById('closeReloadModalBtn'),
            reloadFile1: document.getElementById('reloadFile1'),
            reloadFile2: document.getElementById('reloadFile2'),
            btnReloadSubmit: document.getElementById('btnReloadSubmit'),
            logoContainers: document.querySelectorAll('.simple-animated-logo'), 
            scrollToTopBtn: document.getElementById('scrollToTopBtn'), // <-- THÊM MỚI
            scrollToBottomBtn: document.getElementById('scrollToBottomBtn'), // <-- THÊM MỚI
            
            // === THAY ĐỔI: DOM cho bộ lọc vùng ===
            regionDefinitionsInput: document.getElementById('regionDefinitionsInput'),
            btnSaveRegions: document.getElementById('btnSaveRegions'),
            regionSelect: document.getElementById('regionSelect'),
            btnClearSummaryFilter: document.getElementById('btnClearSummaryFilter'),
            summaryTitle: document.getElementById('summaryTitle'), // <-- THÊM MỚI
            
            // === THÊM MỚI: DOM cho bộ lọc doanh số ===
            sortSelect: document.getElementById('sortSelect'),
            minRevenueInput: document.getElementById('minRevenueInput'),
            maxRevenueInput: document.getElementById('maxRevenueInput'),
            btnApplyRevenueFilter: document.getElementById('btnApplyRevenueFilter'),
            btnClearRevenueFilter: document.getElementById('btnClearRevenueFilter'),
            // === KẾT THÚC THÊM MỚI ===
            
            // === THÊM MỚI: DOM cho modal mật khẩu ===
            passwordModal: document.getElementById('passwordModal'),
            closePasswordModalBtn: document.getElementById('closePasswordModalBtn'),
            passwordInput: document.getElementById('passwordInput'),
            btnSubmitPassword: document.getElementById('btnSubmitPassword'),
            cancelPasswordBtn: document.getElementById('cancelPasswordBtn'),
        };
        
        const manualFormOrder = [
            'manualAgentName', 'manualDateRange', 'manualLotoDB', 'manualLoCap', 
            'manualC227', 'manualC323', 'manualThuong'
        ];

        // ===== CORE LOGIC: FILE HANDLING =====
        function handleFile(file, fileNumber, inputId) {
            if (!file) return;
            showLoading(); 
            const fileInput = document.getElementById(inputId); 
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: "array" });
                    
                    // --- ĐÃ SỬA LỖI SHEET EXCEL TẠI ĐÂY ---
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]]; 
                    
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: "" });
                    if (!jsonData || jsonData.length === 0) { throw new Error("File không có dữ liệu hoặc định dạng không hợp lệ."); }
                    if (fileNumber === 1) {
                        excelData1 = jsonData;
                        let dateRow = jsonData.find(r => Object.values(r).some(v => typeof v === "string" && v.includes("Tõ ngµy")));
                        if (dateRow) {
                            let text = Object.values(dateRow).find(v => typeof v === "string" && v.includes("Tõ ngµy"));
                            let matchRange = text.match(/Tõ ngµy\s*(\d{2}\/\d{2})\/\d{4}.*®Õn ngµy\s*(\d{2}\/\d{2})\/\d{4}/);
                            if (matchRange) { dateRangeText = matchRange[1] === matchRange[2] ? `Ngày ${matchRange[1]}` : `Từ ${matchRange[1]} đến ${matchRange[2]}`; }
                        } else {
                            let singleDateRow = jsonData.find(r => Object.values(r).some(v => typeof v === "string" && v.match(/(\d{2}\/\d{2}\/\d{4})/i)));
                            if (singleDateRow) {
                                let singleText = Object.values(singleDateRow).find(v => typeof v === "string" && v.match(/(\d{2}\/\d{2}\/\d{4})/i));
                                let matchSingle = singleText.match(/(\d{2}\/\d{2}\/\d{4})/i);
                                if (matchSingle) { dateRangeText = `Ngày ${matchSingle[1].substring(0, 5)}`; }
                            }
                        }
                    } else {
                        excelData2 = jsonData;
                    }
                    showNotification(`Đã nạp dữ liệu ${file.name} thành công!`, 'success');
                    if (fileInput) fileInput.classList.add('loaded'); 
                } catch (error) {
                    console.error("Lỗi khi xử lý file:", error);
                    showNotification(`Lỗi: ${error.message}. Vui lòng kiểm tra lại file.`, 'error');
                    if (fileInput) { fileInput.classList.remove('loaded'); fileInput.value = ''; }
                } finally {
                    hideLoading(); 
                }
            };
            reader.onerror = () => {
                showNotification(`Không thể đọc file ${file.name}.`, 'error');
                hideLoading();
            }
            reader.readAsArrayBuffer(file);
        }

        // ===== SUMMARY VIEW LOGIC =====
        function processSummaryData(regionFilterRules, revenueFilter) { 
            const individualAgentData = new Map(); 
            const initializeAgent = (code) => { 
                if (!individualAgentData.has(code)) { 
                    individualAgentData.set(code, { totalRevenue: 0, totalCommission: 0, lotoDB: 0, lotoCap: 0, c2_27: 0, c3_23: 0, xskt: 0, thuong: 0 }); 
                } 
            }; 
            excelData1.forEach(row => { 
                const agentCode = String(row.__EMPTY || '').trim(); 
                if (!agentCode || !/\d/.test(agentCode)) return; 
                initializeAgent(agentCode); 
                const data = individualAgentData.get(agentCode); 
                const loto_db_rev = parseFloat(row.__EMPTY_2) || 0; 
                const lo_cap_rev = parseFloat(row.__EMPTY_6) || 0; 
                const c2_27_rev = parseFloat(row.__EMPTY_8) || 0; 
                const c3_23_rev = parseFloat(row.__EMPTY_10) || 0; 
                data.lotoDB += loto_db_rev; 
                data.lotoCap += lo_cap_rev; 
                data.c2_27 += c2_27_rev; 
                data.c3_23 += c3_23_rev; 
                data.thuong += parseFloat(row.__EMPTY_14) || 0; 
                data.totalRevenue += loto_db_rev + lo_cap_rev + c2_27_rev + c3_23_rev; 
                data.totalCommission += (loto_db_rev * 0.08) + (lo_cap_rev * 0.10) + (c2_27_rev * 0.10) + (c3_23_rev * 0.10); 
            }); 
            excelData2.forEach(row => { 
                const agentCode = String(row.__EMPTY || row.__EMPTY_1 || '').trim(); 
                if (!agentCode || !/\d/.test(agentCode)) return; 
                initializeAgent(agentCode); 
                const data = individualAgentData.get(agentCode); 
                const xsktRevenue = (parseFloat(row.__EMPTY_7) || 0) * 1000; 
                data.xskt += xsktRevenue; 
                data.totalRevenue += xsktRevenue; 
                data.totalCommission += xsktRevenue * 0.10; 
            }); 
            
            // === THAY ĐỔI MỚI: Lọc ra các đại lý không có dữ liệu (toàn số 0) ===
            const keysToDeleteZero = []; // Đổi tên biến để tránh trùng lặp
            individualAgentData.forEach((data, key) => {
                // Kiểm tra xem tất cả các trường doanh thu và thưởng có bằng 0 không
                const isAllZero = data.lotoDB === 0 &&
                                  data.lotoCap === 0 &&
                                  data.c3_23 === 0 &&
                                  data.c2_27 === 0 &&
                                  data.xskt === 0 &&
                                  data.thuong === 0;
                
                // Nếu tất cả đều là 0, đánh dấu để xóa
                if (isAllZero) {
                    keysToDeleteZero.push(key);
                }
            });

            // Xóa các đại lý đã đánh dấu
            keysToDeleteZero.forEach(key => {
                individualAgentData.delete(key);
            });
            // === KẾT THÚC THAY ĐỔI ===

            // === THAY ĐỔI: Áp dụng BỘ LỌC VÙNG (NẾU CÓ) ===
            const filteredAgentData = new Map();
            if (regionFilterRules) {
                individualAgentData.forEach((data, agentCode) => {
                    if (agentMatchesFilter(agentCode, regionFilterRules)) {
                        filteredAgentData.set(agentCode, data);
                    }
                });
            } else {
                // Nếu không lọc, chỉ cần sao chép map
                individualAgentData.forEach((data, agentCode) => {
                    filteredAgentData.set(agentCode, data);
                });
            }
            
            // === THÊM MỚI: Áp dụng BỘ LỌC DOANH SỐ (NẾU CÓ) ===
            // Lọc trên kết quả của filteredAgentData
            if (revenueFilter && (revenueFilter.min !== 0 || revenueFilter.max !== Infinity)) {
                const { min, max } = revenueFilter;
                const keysToDeleteRevenue = [];
                filteredAgentData.forEach((data, key) => {
                    // Lọc những đại lý có doanh số NẰM NGOÀI KHOẢNG
                    if (data.totalRevenue < min || data.totalRevenue > max) {
                        keysToDeleteRevenue.push(key);
                    }
                });
                // Xóa những đại lý không thỏa mãn
                keysToDeleteRevenue.forEach(key => filteredAgentData.delete(key));
            }
            // === KẾT THÚC THÊM MỚI ===

            const getAgentNumberString = (code) => String(code).match(/\d+$/)?.[0] || code; // Lấy chuỗi số
            
            const getAgentParts = (code) => { 
                const numStr = getAgentNumberString(code); // Lấy chuỗi số, ví dụ "01"
                const prefix = String(code).replace(numStr, ''); 
                return { num: parseInt(numStr, 10), prefix }; // Lưu giá trị số, ví dụ 1
            }; 
            
            // === THAY ĐỔI: Sắp xếp dựa trên 'filteredAgentData' ===
            const sortedKeys = [...filteredAgentData.keys()].sort((a, b) => { // <-- THAY ĐỔI: dùng filteredAgentData
                const partsA = getAgentParts(a); 
                const partsB = getAgentParts(b); 
                if (partsA.num !== partsB.num) return partsA.num - partsB.num; 
                return partsA.prefix.localeCompare(partsB.prefix); 
            }); 
            
            const groupedData = new Map(); 
            
            sortedKeys.forEach(agentCode => { 
                // === THAY ĐỔI: Gộp nhóm bằng GIÁ TRỊ SỐ ===
                const numericMatch = String(agentCode).match(/\d+$/);
                const groupKey = numericMatch ? parseInt(numericMatch[0], 10) : agentCode; // Dùng giá trị số (ví dụ: 1) làm key

                if (!groupedData.has(groupKey)) { 
                    // === THAY ĐỔI: Thêm groupTotalRevenue và groupTotalThuong ===
                    groupedData.set(groupKey, { agents: [], groupTotal: 0, groupTotalRevenue: 0, groupTotalThuong: 0 }); 
                } 
                const group = groupedData.get(groupKey);
                // === KẾT THÚC THAY ĐỔI ===
                
                // === THAY ĐỔI: Lấy chi tiết từ 'filteredAgentData' ===
                const agentDetails = filteredAgentData.get(agentCode); // <-- THAY ĐỔI: dùng filteredAgentData
                const finalAmount = agentDetails.totalRevenue - agentDetails.totalCommission - agentDetails.thuong; 
                group.agents.push({ code: agentCode, data: agentDetails }); 
                group.groupTotal += finalAmount; 
                group.groupTotalRevenue += agentDetails.totalRevenue; // <-- THÊM DÒNG NÀY
                group.groupTotalThuong += agentDetails.thuong; // <-- THÊM DÒNG NÀY (YÊU CẦU MỚI)
            }); 
            
            // === THAY ĐỔI: Tính tổng Grand Totals dựa trên 'filteredAgentData' ===
            const grandTotals = { lotoDB: 0, lotoCap: 0, c3_23: 0, c2_27: 0, xskt: 0, thuong: 0, finalAmount: 0, totalRevenue: 0 }; 
            filteredAgentData.forEach(data => { // <-- THAY ĐỔI: dùng filteredAgentData
                grandTotals.lotoDB += data.lotoDB; 
                grandTotals.lotoCap += data.lotoCap; 
                grandTotals.c3_23 += data.c3_23; 
                grandTotals.c2_27 += data.c2_27; 
                grandTotals.xskt += data.xskt; 
                grandTotals.thuong += data.thuong; 
                grandTotals.totalRevenue += data.totalRevenue; // <-- THÊM DÒNG NÀY
                grandTotals.finalAmount += data.totalRevenue - data.totalCommission - data.thuong; 
            }); 
            return { groupedData, grandTotals }; 
        }
        
        function renderSummaryTable({ groupedData, grandTotals }, sortMode = 'default') { 
            let body = ''; 
            let stt = 1; 
            
            // === THAY ĐỔI: Chuyển Map thành mảng [key, value] để sắp xếp ===
            let sortedGroupedData = [...groupedData.entries()]; 
            
            // === THÊM MỚI: Logic sắp xếp các nhóm theo sortMode ===
            switch (sortMode) {
                case 'revenue_desc':
                    // Sắp xếp theo tổng doanh số nhóm (groupTotalRevenue), cao xuống thấp
                    sortedGroupedData.sort((a, b) => b[1].groupTotalRevenue - a[1].groupTotalRevenue);
                    break;
                case 'revenue_asc':
                    // Sắp xếp theo tổng doanh số nhóm (groupTotalRevenue), thấp lên cao
                    sortedGroupedData.sort((a, b) => a[1].groupTotalRevenue - b[1].groupTotalRevenue);
                    break;
                case 'default':
                default:
                    // Sắp xếp Mặc định: theo groupKey (số sổ), thấp lên cao
                    sortedGroupedData.sort((a, b) => parseInt(a[0], 10) - parseInt(b[0], 10));
                    break;
            }
            // === KẾT THÚC THÊM MỚI ===
            
            // === THAY ĐỔI: Lặp qua mảng đã sắp xếp (sortedGroupedData) ===
            for (const [groupKey, group] of sortedGroupedData) { 
                group.agents.forEach((agent, index) => { 
                    const agentData = agent.data; 
                    const finalAmount = agentData.totalRevenue - agentData.totalCommission - agentData.thuong; 
                    const isFirstInGroup = index === 0; 
                    const sttCell = isFirstInGroup ? `<td>${stt}</td>` : '<td></td>'; 
                    let finalAmountCellContent = finalAmount < 0 ? `<span class="negative-value">${formatNumberHiddenK(finalAmount)}</span>` : formatNumberHiddenK(finalAmount); 
                    
                    // === THÊM MỚI: Logic cho cột Dsố (Theo yêu cầu mới) ===
                    let dsoCellContent = formatNumberHiddenK(agentData.totalRevenue);
                    // === THÊM MỚI: Logic cho cột Thưởng (Theo yêu cầu mới) ===
                    let thuongCellContent = formatNumberHiddenK(agentData.thuong);
                    // === KẾT THÚC THÊM MỚI ===

                    // === THAY ĐỔI LOGIC HIỂN THỊ TỔNG NHÓM (Xuống dòng) ===
                    if (index === group.agents.length - 1 && group.agents.length > 1) {
                        finalAmountCellContent += `<br><strong style="color: var(--primary-color); font-size: 0.9em;">(${formatNumberHiddenK(group.groupTotal)})</strong>`; 
                        
                        // === THÊM MỚI: Thêm tổng cho cột Dsố (Theo yêu cầu mới) ===
                        dsoCellContent += `<br><strong style="color: var(--primary-color); font-size: 0.9em;">(${formatNumberHiddenK(group.groupTotalRevenue)})</strong>`;
                        // === THÊM MỚI: Thêm tổng cho cột Thưởng (Theo yêu cầu mới) ===
                        thuongCellContent += `<br><strong style="color: var(--primary-color); font-size: 0.9em;">(${formatNumberHiddenK(group.groupTotalThuong)})</strong>`;
                    } 
                    // === KẾT THÚC THAY ĐỔI ===

                    // === THAY ĐỔI: Thêm cột Dsố (dsoCellContent) và Thưởng (thuongCellContent) ===
                    body += `<tr ${isFirstInGroup ? 'class="group-start-row"' : ''}>${sttCell}<td>${agent.code}</td><td>${formatNumberHiddenK(agentData.lotoDB)}</td><td>${formatNumberHiddenK(agentData.lotoCap)}</td><td>${formatNumberHiddenK(agentData.c3_23)}</td><td>${formatNumberHiddenK(agentData.c2_27)}</td><td>${formatNumberHiddenK(agentData.xskt)}</td><td>${dsoCellContent}</td><td>${thuongCellContent}</td><td>${finalAmountCellContent}</td></tr>`; 
                }); 
                stt++; 
            } 
            const grandFinalAmountClass = grandTotals.finalAmount >= 0 ? 'final-amount-positive' : 'final-amount-negative'; 
            
            // === THAY ĐỔI: Thêm cột Dsố vào footer ===
            const footer = `<tr><td colspan="2">TỔNG CỘNG</td><td>${formatNumberHiddenK(grandTotals.lotoDB)}</td><td>${formatNumberHiddenK(grandTotals.lotoCap)}</td><td>${formatNumberHiddenK(grandTotals.c3_23)}</td><td>${formatNumberHiddenK(grandTotals.c2_27)}</td><td>${formatNumberHiddenK(grandTotals.xskt)}</td><td>${formatNumberHiddenK(grandTotals.totalRevenue)}</td><td>${formatNumberHiddenK(grandTotals.thuong)}</td><td class="${grandFinalAmountClass}">${formatNumberHiddenK(grandTotals.finalAmount)}</td></tr>`; 
            
            // === THAY ĐỔI: Thêm cột Dsố vào header và đổi "Tiền" thành "Tiền nộp" ===
            return `<table border="1"><thead><tr><th style="width: 8%;">STT</th><th style="width: 12%;">ĐL</th><th>LTô</th><th>LCặp</th><th>3/23</th><th>2/27</th><th>XSKT</th><th>Dsố</th><th>Thưởng</th><th>Tiền nộp</th></tr></thead><tbody>${body}</tbody><tfoot>${footer}</tfoot></table>`; 
        }
        // === KẾT THÚC THAY ĐỔI ===

        function generateSummaryView() { 
            if (excelData1.length === 0 && excelData2.length === 0) return; 

            // === THAY ĐỔI: Lấy quy tắc lọc VÙNG ===
            const selectedRegion = DOM.regionSelect.value;
            let regionFilterRules = null;
            if (selectedRegion !== 'all') {
                regionFilterRules = regionDefinitions[selectedRegion]; // Lấy quy tắc đã lưu
            }
            // === KẾT THÚC THAY ĐỔI ===

            // === THÊM MỚI: Lấy quy tắc lọc DOANH SỐ ===
            // Lấy giá trị từ data-value (do class 'manual-currency' gán vào)
            const minVal = parseFloat(DOM.minRevenueInput.dataset.value);
            const maxVal = parseFloat(DOM.maxRevenueInput.dataset.value);

            // Chuyển từ nghìn sang đồng. Nếu NaN hoặc 0, dùng giá trị mặc định.
            const minRevenue = (minVal || 0) * 1000;
            // Nếu maxVal là NaN hoặc 0 (người dùng không nhập) thì dùng Infinity
            const maxRevenue = (!maxVal || maxVal === 0) ? Infinity : maxVal * 1000;

            const revenueFilter = {
                min: minRevenue,
                max: maxRevenue
            };

            // === THÊM MỚI: Lấy quy tắc SẮP XẾP ===
            const sortMode = DOM.sortSelect.value;
            // === KẾT THÚC THÊM MỚI ===

            // === THAY ĐỔI: Truyền TẤT CẢ bộ lọc vào processSummaryData ===
            const summaryData = processSummaryData(regionFilterRules, revenueFilter); // <-- THAY ĐỔI
            
            // === THAY ĐỔI: Truyền sortMode vào renderSummaryTable ===
            const tableHTML = renderSummaryTable(summaryData, sortMode); // <-- THAY ĐỔI
            
            DOM.summaryTableContainer.innerHTML = tableHTML; 
            
            // === THAY ĐỔI: Cập nhật tiêu đề và Tổng Doanh Số (Style mới) ===
            const totalRevenue = summaryData.grandTotals.totalRevenue;
            const totalThuong = summaryData.grandTotals.thuong;

            const totalRevenueFormattedK = formatNumberHiddenK(totalRevenue);
            const totalThuongFormattedK = formatNumberHiddenK(totalThuong);
            
            let thuongPercentage = 0;
            if (totalRevenue !== 0) {
                thuongPercentage = (totalThuong / totalRevenue) * 100;
            }
            
            // === THAY ĐỔI: Cập nhật text của tiêu đề (dùng innerHTML) ===
            const baseTitle = 'Bảng Báo Cáo Tổng Hợp:';
            if (selectedRegion === 'all') {
                DOM.summaryTitle.innerHTML = baseTitle;
            } else {
                DOM.summaryTitle.innerHTML = `${baseTitle} <span class="region-name">${selectedRegion}</span>`;
            }
            // === KẾT THÚC THAY ĐỔI ===

            // === THAY ĐỔI: Hiển thị Doanh số và Trả thưởng (theo yêu cầu mới) ===
            const revenueSpan = `<span style="font-weight: 500; color: var(--text-color);">Doanh số: <span style="font-weight: 600; color: var(--danger-color);">${totalRevenueFormattedK}</span></span>`;
            const thuongSpan = `<span style="font-weight: 500; color: var(--text-color); margin-left: 15px;">Trả thưởng: <span style="font-weight: 600; color: var(--primary-dark);">${totalThuongFormattedK}</span> (${thuongPercentage.toFixed(1)}%)</span>`;

            DOM.summaryDate.innerHTML = `${dateRangeText} <br> ${revenueSpan} ${thuongSpan}`;
        }

        // ===== DETAILED REPORT VIEW LOGIC =====
        function resetState(soSo) { state.currentSoSo = soSo; state.baseTongDT = 0; state.baseTongHH = 0; state.baseThuong = 0; state.extraBonus = 0; state.extraDebt = 0; state.addedTickets = []; state.accountCodes.clear(); }
        function processDetailedReportData(soSo) { 
            const filterBySoSo = (row) => { 
                const agentCode = String(row.__EMPTY || row.__EMPTY_1 || '').trim(); 
                if (!agentCode) return false; 
                const numericPartMatch = agentCode.match(/\d+$/); 
                if (!numericPartMatch) return false; 
                
                // === THAY ĐỔI: So sánh giá trị số thay vì văn bản ===
                return parseInt(numericPartMatch[0], 10) === parseInt(soSo, 10); 
                // === KẾT THÚC THAY ĐỔI ===
            }; 
            const filtered1 = excelData1.filter(filterBySoSo); 
            const filtered2 = excelData2.filter(filterBySoSo); 
            if (filtered1.length === 0 && filtered2.length === 0) return null; 
            resetState(soSo); 
            const totalsFromExcel = { lotoDB: 0, loCap: 0, c2_27: 0, c3_23: 0, thuong: 0, xskt: 0 }; 
            filtered1.forEach(row => { 
                state.accountCodes.add(String(row.__EMPTY).trim()); 
                totalsFromExcel.lotoDB += parseFloat(row.__EMPTY_2) || 0; 
                totalsFromExcel.loCap += parseFloat(row.__EMPTY_6) || 0; 
                totalsFromExcel.c2_27 += parseFloat(row.__EMPTY_8) || 0; 
                totalsFromExcel.c3_23 += parseFloat(row.__EMPTY_10) || 0; 
                totalsFromExcel.thuong += parseFloat(row.__EMPTY_14) || 0; 
            }); 
            filtered2.forEach(row => { 
                state.accountCodes.add(String(row.__EMPTY || row.__EMPTY_1).trim()); 
                totalsFromExcel.xskt += (parseFloat(row.__EMPTY_7) || 0) * 1000; 
            }); 
            const loto_db_com = totalsFromExcel.lotoDB * 0.08; 
            const lo_cap_com = totalsFromExcel.loCap * 0.10; 
            const c2_27_com = totalsFromExcel.c2_27 * 0.10; 
            const c3_23_com = totalsFromExcel.c3_23 * 0.10; 
            const xskt_com = totalsFromExcel.xskt * 0.10; 
            state.baseTongDT = totalsFromExcel.lotoDB + totalsFromExcel.loCap + totalsFromExcel.c2_27 + totalsFromExcel.c3_23 + totalsFromExcel.xskt; 
            state.baseTongHH = loto_db_com + lo_cap_com + c2_27_com + c3_23_com + xskt_com; 
            state.baseThuong = totalsFromExcel.thuong; 
            return { totals: totalsFromExcel, commissions: { loto_db_com, lo_cap_com, c2_27_com, c3_23_com, xskt_com } }; 
        }
        
        function renderDetailedReport(data, manualDateRange = null) { 
            const { totals, commissions } = data; 
            const displayDate = manualDateRange !== null ? manualDateRange : dateRangeText; 
            const xsktRowHTML = totals.xskt > 0 ? `<tr><td>Xổ số kiến thiết</td><td>${formatNumberHiddenK(totals.xskt)}</td><td>${formatCommissionCellHiddenK(totals.xskt, commissions.xskt_com)}</td></tr>` : ''; 
            
            // === THAY ĐỔI: Thêm id="bangChuRow" vào dòng "Bằng chữ" ===
            DOM.reportContainer.innerHTML = `<table><tr><td class="header" style="width: 33.33%;">Thanh toán tiền Đại Lý:</td><td class="so-so">${[...state.accountCodes].join(', ')}</td></tr><tr><td class="header">Thời gian:</td><td>${displayDate}</td></tr></table><br><table class="report-table"><thead><tr><th>Loại hình</th><th>Doanh thu</th><th>Hoa hồng</th></tr></thead><tbody><tr><td>Lô tô Đặc biệt</td><td>${formatNumberHiddenK(totals.lotoDB)}</td><td>${formatCommissionCellHiddenK(totals.lotoDB, commissions.loto_db_com)}</td></tr><tr><td>Lô cặp</td><td>${formatNumberHiddenK(totals.loCap)}</td><td>${formatCommissionCellHiddenK(totals.loCap, commissions.lo_cap_com)}</td></tr><tr><td>2/27</td><td>${formatNumberHiddenK(totals.c2_27)}</td><td>${formatCommissionCellHiddenK(totals.c2_27, commissions.c2_27_com)}</td></tr><tr><td>3/23</td><td>${formatNumberHiddenK(totals.c3_23)}</td><td>${formatCommissionCellHiddenK(totals.c3_23, commissions.c3_23_com)}</td></tr>${xsktRowHTML}<tr id="tongCongRow"><td>Tổng cộng</td><td id="tongDT"></td><td id="tongHH"></td></tr><tr id="mainBonusRow"><td>Thưởng</td><td colspan="2" id="thuong">${formatNumberHiddenK(state.baseThuong)}</td></tr><tr id="finalResultRow"><td id="ketQuaLabel"></td><td id="ketQuaValue" colspan="2"></td></tr><tr id="bangChuRow" class="header"><td>Bằng chữ</td><td colspan="2" id="ketQuaBangChu" class="bang-chu-cell"></td></tr></tbody></table><div id="copyrightInReport" class="copyright" style="display: none;">© 2025 ZENG FINANCE</div>`; 
            // === KẾT THÚC THAY ĐỔI ===
        }
        function updateDetailedReportView() { 
            if (!state.currentSoSo) return; 
            const addedRevenue = state.addedTickets.reduce((sum, t) => sum + t.doanhThu, 0); 
            const addedCommission = state.addedTickets.reduce((sum, t) => sum + t.hoaHong, 0); 
            const tongDT_Moi = state.baseTongDT + addedRevenue; 
            const tongHH_Moi = state.baseTongHH + addedCommission; 
            const tongDTElement = document.getElementById('tongDT'); 
            const tongHHElement = document.getElementById('tongHH'); 
            if (tongDTElement) tongDTElement.textContent = formatNumberHiddenK(tongDT_Moi); 
            if (tongHHElement) tongHHElement.textContent = formatNumberHiddenK(tongHH_Moi); 
            const phaiNop = tongDT_Moi - tongHH_Moi - state.baseThuong - state.extraBonus + state.extraDebt; 
            const resultRow = document.getElementById('finalResultRow'); 
            const ketQuaLabel = document.getElementById('ketQuaLabel'); 
            const ketQuaValue = document.getElementById('ketQuaValue'); 
            const ketQuaBangChu = document.getElementById('ketQuaBangChu'); 
            if (!resultRow || !ketQuaLabel || !ketQuaValue || !ketQuaBangChu) return; 
            resultRow.className = phaiNop >= 0 ? 'final-amount-positive' : 'final-amount-negative'; 
            if (phaiNop >= 0) { 
                const lamTron = Math.ceil(phaiNop / 1000) * 1000; 
                ketQuaLabel.textContent = 'Phải nộp'; /* <-- THAY ĐỔI: Bỏ dấu : */
                ketQuaValue.textContent = formatNumberHiddenK(lamTron); 
                ketQuaBangChu.textContent = docso(lamTron) + " đồng"; 
            } else { 
                const layVe = Math.abs(phaiNop); 
                const khongLamTron = parseInt(layVe / 1000) * 1000; 
                ketQuaLabel.textContent = 'Lấy về'; /* <-- THAY ĐỔI: Bỏ dấu : */
                ketQuaValue.textContent = formatNumberHiddenK(khongLamTron); 
                ketQuaBangChu.textContent = docso(khongLamTron) + " đồng"; 
            } 
        }

        // ===== UI EVENT HANDLERS & CONTROLLERS =====
        function initializeApp() {
            DOM.btnLoadData.addEventListener('click', () => { 
                if (excelData1.length === 0 && excelData2.length === 0) { 
                    showNotification("Vui lòng chọn ít nhất một file excel!", 'error'); 
                    return; 
                } 
                generateSummaryView(); // <-- Sẽ chạy với bộ lọc "Tất cả" mặc định
                DOM.homePage.style.display = 'none'; 
                DOM.mainPage.style.display = 'block'; 
                showSection('reportSection'); 
                loopLogoAnimation(); 
            });
            DOM.navSummary.addEventListener('click', () => showSection('summarySection'));
            DOM.navReport.addEventListener('click', () => showSection('reportSection'));
            DOM.navSell.addEventListener('click', () => showSection('sellSection'));
            DOM.excelFile1.addEventListener('change', (e) => handleFile(e.target.files[0], 1, 'excelFile1'));
            DOM.excelFile2.addEventListener('change', (e) => handleFile(e.target.files[0], 2, 'excelFile2'));
            DOM.btnCreateReport.addEventListener('click', createDetailedReport);
            DOM.soSoInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.target.blur(); createDetailedReport(); } });
            document.querySelectorAll('.manual-currency').forEach(input => { input.addEventListener('input', (e) => { const value = e.target.value.replace(/\D/g, ''); e.target.dataset.value = value; e.target.value = value ? parseInt(value, 10).toLocaleString('vi-VN') : ''; }); });
            
            DOM.btnShowManualReport.addEventListener('click', showManualInputModal);
            DOM.btnShowManualReport_inline.addEventListener('click', showManualInputModal);
            DOM.btnCreateManualReport.addEventListener('click', createManualReport);
            DOM.btnClearManualReport.addEventListener('click', clearManualReportForm); 
            manualFormOrder.forEach(id => { const element = document.getElementById(id); if (element) { element.addEventListener('keydown', handleManualFormEnter); } });
            
            // === THAY ĐỔI: Gán sự kiện cho nút "Lưu ảnh" ===
            DOM.btnSaveSummary.addEventListener('click', () => saveElementAsImage('#summarySection', 'Báo-cáo-Tổng-kết.png', DOM.btnSaveSummary));
            
            DOM.btnCopySummary.addEventListener('click', () => copyElementAsImage('#summarySection', 'Copy ảnh tổng kết thành công!', DOM.btnCopySummary));
            
            /* XÓA BỎ: btnToggleSummaryView */
            
            DOM.btnCopyReport.addEventListener('click', () => copyElementAsImage('#reportContainer', 'Copy ảnh báo cáo thành công!', DOM.btnCopyReport));
            DOM.toggleChoicesBtn.addEventListener('click', toggleActionChoices);
            DOM.sellTicketTypeRadios.forEach(radio => radio.addEventListener('change', handleSellOptionsChange));
            DOM.sellPriceRadios.forEach(radio => radio.addEventListener('change', handleSellOptionsChange));
            DOM.commissionRateRadios.forEach(radio => radio.addEventListener('change', handleSellOptionsChange));
            DOM.customTicketPrice.addEventListener('input', (e) => { const value = e.target.value.replace(/\D/g, ''); e.target.value = value ? parseInt(value, 10).toLocaleString('vi-VN') : ''; });
            DOM.sellQuantityInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); DOM.btnAddTicket.click(); } });
            DOM.btnAddTicket.addEventListener('click', addTicketToReport);
            DOM.closeModalBtn.addEventListener('click', hideManualInputModal);
            DOM.manualInputModal.addEventListener('click', (event) => { if (event.target === DOM.manualInputModal) { hideManualInputModal(); } });
            DOM.closePreviewModalBtn.addEventListener('click', hideImagePreviewModal);
            DOM.imagePreviewModal.addEventListener('click', (event) => { if (event.target === DOM.imagePreviewModal) { hideImagePreviewModal(); } });
            DOM.navReload.addEventListener('click', showReloadModal);
            DOM.closeReloadModalBtn.addEventListener('click', hideReloadModal);
            DOM.reloadModal.addEventListener('click', (e) => { if (e.target === DOM.reloadModal) hideReloadModal(); });
            DOM.reloadFile1.addEventListener('change', (e) => handleFile(e.target.files[0], 1, 'reloadFile1'));
            DOM.reloadFile2.addEventListener('change', (e) => handleFile(e.target.files[0], 2, 'reloadFile2'));
            DOM.btnReloadSubmit.addEventListener('click', submitReload);

            // === THAY ĐỔI: Sự kiện cho Định nghĩa Vùng & Mật khẩu ===
            DOM.btnSaveRegions.addEventListener('click', handleRegionButtonPress); // <-- THAY ĐỔI
            DOM.regionSelect.addEventListener('change', generateSummaryView); // Tự động lọc khi chọn
            DOM.btnClearSummaryFilter.addEventListener('click', () => {
                DOM.regionSelect.value = 'all';
                generateSummaryView(); // Chạy lại với bộ lọc rỗng
            });
            
            // Listener cho modal mật khẩu
            DOM.closePasswordModalBtn.addEventListener('click', hidePasswordModal);
            DOM.cancelPasswordBtn.addEventListener('click', hidePasswordModal);
            DOM.passwordModal.addEventListener('click', (e) => { if (e.target === DOM.passwordModal) hidePasswordModal(); });
            DOM.btnSubmitPassword.addEventListener('click', checkPassword);
            DOM.passwordInput.addEventListener('keydown', (e) => { 
                if (e.key === 'Enter') { 
                    e.preventDefault(); // Ngăn hành vi mặc định của Enter (nếu có)
                    checkPassword(); 
                } 
            });
            // === KẾT THÚC THAY ĐỔI ===


            // === THÊM MỚI: Sự kiện cho nút cuộn lên đầu ===
            DOM.scrollToTopBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            // === THÊM MỚI: Sự kiện cho nút cuộn xuống dưới ===
            DOM.scrollToBottomBtn.addEventListener('click', () => {
                window.scrollTo({ top: document.documentElement.scrollHeight, behavior: 'smooth' });
            });

            window.addEventListener('scroll', handleScrollButtonVisibility);
            // === KẾT THÚC THÊM MỚI ===

            // === THÊM MỚI: Tải định nghĩa vùng đã lưu ===
            loadSavedRegions();
            // === KẾT THÚC THÊM MỚI ===

            // === THÊM MỚI: Sự kiện cho bộ lọc doanh số ===
            DOM.btnApplyRevenueFilter.addEventListener('click', generateSummaryView);
            DOM.btnClearRevenueFilter.addEventListener('click', () => {
                DOM.sortSelect.value = 'default';
                DOM.minRevenueInput.value = '';
                if(DOM.minRevenueInput.dataset) DOM.minRevenueInput.dataset.value = ''; // Xóa data-value
                DOM.maxRevenueInput.value = '';
                if(DOM.maxRevenueInput.dataset) DOM.maxRevenueInput.dataset.value = ''; // Xóa data-value
                generateSummaryView();
            });
            // Thêm Enter key cho input (chú ý: class 'manual-currency' đã xử lý format)
            DOM.minRevenueInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') DOM.btnApplyRevenueFilter.click(); });
            DOM.maxRevenueInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') DOM.btnApplyRevenueFilter.click(); });
            // === KẾT THÚC THÊM MỚI ===

            loopLogoAnimation(); // Bắt đầu animation logo lần đầu tiên
        }
        
        // --- LOGIC ANIMATION LOGO MỚI ---
        function getRandomColor() {
            const h = Math.floor(Math.random() * 360); // Hue (0-359)
            const s = Math.floor(Math.random() * 30) + 70; // Saturation (70-100)
            const l = Math.floor(Math.random() * 20) + 40; // Lightness (40-60)
            return `hsl(${h}, ${s}%, ${l}%)`;
        }

        async function loopLogoAnimation() {
            try {
                const spans = document.querySelectorAll('.simple-animated-logo span');
                if (spans.length === 0) return; // Dừng nếu không tìm thấy logo

                const chars = Array.from(spans);
                const delay = (ms) => new Promise(res => setTimeout(res, ms));

                // Phase 1: Fade In (từng ký tự)
                for (let i = 0; i < chars.length; i++) {
                    chars[i].style.opacity = '1';
                    chars[i].style.transform = 'translateY(0)';
                    await delay(150); // Delay giữa các ký tự
                }
                
                // Phase 2: Đợi
                await delay(3000); // Giữ 3 giây

                // Phase 3: Fade Out (cùng lúc)
                chars.forEach(span => {
                    span.style.opacity = '0';
                    span.style.transform = 'translateY(15px)';
                });

                // Đợi fade out hoàn tất
                await delay(600); // 0.6s (thời gian transition + 0.1s đệm)

                // Phase 4: Đổi màu
                const newColor = getRandomColor();
                DOM.logoContainers.forEach(logo => {
                    logo.style.color = newColor;
                });
                
                // Lặp lại
                setTimeout(loopLogoAnimation, 100); // Đợi 1 chút trước khi lặp lại

            } catch (error) {
                console.error("Lỗi animation logo:", error);
            }
        }
        // --- KẾT THÚC LOGIC LOGO ---
        
        /* XÓA BỎ: Hàm toggleSummaryViewMode */
        
        // === THÊM MỚI: Hàm xử lý hiển thị nút cuộn lên đầu ===
        function handleScrollButtonVisibility() {
            const scrollTop = window.scrollY || document.documentElement.scrollTop;
            const scrollHeight = document.documentElement.scrollHeight;
            const clientHeight = document.documentElement.clientHeight;
            const summarySectionVisible = DOM.summarySection.style.display !== 'none';
            
            // Logic cho nút Lên Đầu
            if (scrollTop > 200 && summarySectionVisible) {
                DOM.scrollToTopBtn.classList.add('show');
            } else {
                DOM.scrollToTopBtn.classList.remove('show');
            }

            // Logic cho nút Xuống Dưới
            if (scrollTop < (scrollHeight - clientHeight - 200) && summarySectionVisible) {
                DOM.scrollToBottomBtn.classList.add('show');
            } else {
                DOM.scrollToBottomBtn.classList.remove('show');
            }
        }
        // === KẾT THÚC THÊM MỚI ===

        function createDetailedReport() { 
            hideManualInputModal(); 
            const soSo = DOM.soSoInput.value.trim(); 
            if (!soSo) return showNotification("Vui lòng nhập số sổ!", 'error'); 
            if (excelData1.length === 0 && excelData2.length === 0) return showNotification("Chưa có dữ liệu Excel được nạp!", 'error'); 
            const reportData = processDetailedReportData(soSo); 
            if (!reportData) { return showNotification(`Không tìm thấy số sổ '${soSo}' trong dữ liệu!`, 'error'); } 
            renderDetailedReport(reportData); 
            updateDetailedReportView(); 
            DOM.actionButtonContainer.style.display = 'grid'; 
            DOM.actionChoices.style.display = 'none'; 
            DOM.toggleChoicesBtn.textContent = 'Thêm tiền Thưởng/Nợ'; 
            DOM.toggleChoicesBtn.className = 'secondary'; 
            updateActionButtons(); 
            DOM.reportContainer.scrollIntoView({ behavior: 'smooth' }); 
        }
        function handleManualFormEnter(event) { if (event.key !== 'Enter') return; event.preventDefault(); const currentId = event.target.id; const currentIndex = manualFormOrder.indexOf(currentId); if (currentIndex === -1) return; if (currentIndex < manualFormOrder.length - 1) { const nextId = manualFormOrder[currentIndex + 1]; document.getElementById(nextId)?.focus(); } else { DOM.btnCreateManualReport.click(); } } 
        function clearManualReportForm() { manualFormOrder.forEach(id => { const element = document.getElementById(id); if (element) { element.value = ''; if (element.dataset.value) { element.dataset.value = ''; } } }); document.getElementById('manualAgentName').focus(); } 
        
        // Modal functions
        function showManualInputModal() {
            clearManualReportForm(); 
            DOM.manualInputModal.style.display = 'block';
            document.getElementById('manualAgentName').focus(); 
        }
        function hideManualInputModal() {
            DOM.manualInputModal.style.display = 'none';
        }
        function hideImagePreviewModal() {
            DOM.imagePreviewModal.style.display = 'none';
            DOM.imagePreviewHolder.src = ''; 
        }

        // --- HÀM CHO VIỆC NẠP LẠI EXCEL ---
        function showReloadModal() {
            DOM.reloadModal.style.display = 'block';
            DOM.reloadFile1.value = ''; DOM.reloadFile2.value = '';
            DOM.reloadFile1.classList.remove('loaded'); DOM.reloadFile2.classList.remove('loaded');
        }
        function hideReloadModal() { DOM.reloadModal.style.display = 'none'; }
        function submitReload() {
            if (DOM.reloadFile1.files.length === 0 && excelData1.length === 0 && DOM.reloadFile2.files.length === 0 && excelData2.length === 0) {
                 showNotification("Bạn chưa chọn file Excel nào để nạp.", 'error');
                 return;
            }
            generateSummaryView(); // <-- Sẽ chạy với bộ lọc "Tất cả" mặc định
            DOM.reportContainer.innerHTML = '';
            DOM.actionButtonContainer.style.display = 'none';
            DOM.soSoInput.value = '';
            state.currentSoSo = null;
            hideReloadModal();
            showSection('summarySection');
            showNotification("Đã nạp lại dữ liệu Excel thành công!", 'success');
        }

        function createManualReport() { 
            const agentName = DOM.manualAgentName.value.trim(); if (!agentName) return showNotification("Vui lòng nhập Tên Đại Lý!", 'error'); 
            const totals = { lotoDB: (parseFloat(DOM.manualLotoDB.dataset.value) || 0) * 1000, loCap: (parseFloat(DOM.manualLoCap.dataset.value) || 0) * 1000, c2_27: (parseFloat(DOM.manualC227.dataset.value) || 0) * 1000, c3_23: (parseFloat(DOM.manualC323.dataset.value) || 0) * 1000, thuong: parseFloat(DOM.manualThuong.dataset.value) || 0, xskt: 0 }; 
            const commissions = { loto_db_com: totals.lotoDB * 0.08, lo_cap_com: totals.loCap * 0.10, c2_27_com: totals.c2_27 * 0.10, c3_23_com: totals.c3_23 * 0.10, xskt_com: 0 }; 
            resetState('manual'); state.accountCodes.add(agentName); state.baseTongDT = totals.lotoDB + totals.loCap + totals.c2_27 + totals.c3_23; state.baseTongHH = commissions.loto_db_com + commissions.lo_cap_com + commissions.c2_27_com + commissions.c3_23_com; state.baseThuong = totals.thuong; 
            if (DOM.homePage.style.display !== 'none') { DOM.homePage.style.display = 'none'; DOM.mainPage.style.display = 'block'; }
            showSection('reportSection'); 
            renderDetailedReport({ totals, commissions }, DOM.manualDateRange.value.trim()); 
            updateDetailedReportView(); 
            hideManualInputModal(); 
            DOM.actionButtonContainer.style.display = 'grid'; 
            DOM.reportContainer.scrollIntoView({ behavior: 'smooth' }); 
            showNotification('Đã thêm báo cáo thủ công thành công!', 'success');
        }
        
        function showSection(sectionId) { 
            [DOM.summarySection, DOM.reportSection, DOM.sellSection].forEach(s => s.style.display = 'none'); 
            const sectionToShow = document.getElementById(sectionId);
            if(sectionToShow) sectionToShow.style.display = 'block';
            
            [DOM.navSummary, DOM.navReport, DOM.navSell, DOM.navReload].forEach(b => b.classList.remove('active')); 
            
            // Tìm nút nav tương ứng
            let activeBtn;
            if (sectionId === 'summarySection') activeBtn = DOM.navSummary;
            else if (sectionId === 'reportSection') activeBtn = DOM.navReport;
            else if (sectionId === 'sellSection') activeBtn = DOM.navSell;
            // Không làm active nút "Nạp lại"
            
            if(activeBtn) activeBtn.classList.add('active'); 
            else DOM.navSummary.classList.add('active'); // Mặc định

            // === THÊM MỚI: Cập nhật hiển thị nút cuộn lên đầu ===
            if (sectionId !== 'summarySection') {
                DOM.scrollToTopBtn.classList.remove('show');
                DOM.scrollToBottomBtn.classList.remove('show'); // <-- THÊM MỚI
            } else {
                // Kiểm tra ngay lập tức xem có nên hiển thị nút không
                handleScrollButtonVisibility();
            }
            // === KẾT THÚC THÊM MỚI ===
        }
        function toggleActionChoices() { if (DOM.toggleChoicesBtn.textContent.includes('Thêm')) { DOM.actionChoices.style.display = 'grid'; DOM.toggleChoicesBtn.textContent = 'Xoá hết Thưởng/Nợ'; DOM.toggleChoicesBtn.className = 'danger'; } else { document.getElementById('extraBonusRow')?.remove(); document.getElementById('extraDebtRow')?.remove(); state.extraBonus = 0; state.extraDebt = 0; updateDetailedReportView(); DOM.actionChoices.style.display = 'none'; DOM.toggleChoicesBtn.textContent = 'Thêm tiền Thưởng/Nợ'; DOM.toggleChoicesBtn.className = 'secondary'; } updateActionButtons(); }
        function updateActionButtons() { DOM.actionChoices.innerHTML = `${document.getElementById('extraBonusRow') ? `<button class="danger" data-action="remove-bonus">Xoá Thưởng thêm</button>` : `<button data-action="add-bonus">Thêm tiền Thưởng</button>`}${document.getElementById('extraDebtRow') ? `<button class="danger" data-action="remove-debt">Xoá tiền Nợ</button>` : `<button data-action="add-debt">Thêm tiền Nợ</button>`}`; }
        DOM.actionChoices.addEventListener('click', (e) => { const action = e.target.dataset.action; if (!action) return; const actionMap = { 'add-bonus': () => createDynamicInputRow('bonus'), 'remove-bonus': () => { document.getElementById('extraBonusRow')?.remove(); state.extraBonus = 0; updateDetailedReportView(); }, 'add-debt': () => createDynamicInputRow('debt'), 'remove-debt': () => { document.getElementById('extraDebtRow')?.remove(); state.extraDebt = 0; updateDetailedReportView(); } }; actionMap[action]?.(); updateActionButtons(); });
        function createDynamicInputRow(type) { const isBonus = type === 'bonus'; const existingRow = document.getElementById(isBonus ? 'extraBonusRow' : 'extraDebtRow'); if (existingRow) return; const mainBonusRow = document.getElementById('mainBonusRow'); if (!mainBonusRow) return; const newRow = document.createElement('tr'); newRow.id = isBonus ? 'extraBonusRow' : 'extraDebtRow'; if (!isBonus) newRow.className = 'old-debt'; const nameCellHTML = isBonus ? `<td style="display: flex; align-items: center;"><textarea class="dynamic-input" style="color: var(--success-color);" placeholder="Nhập tên thưởng..." rows="1"></textarea></td>` : `<td style="vertical-align: middle;">Nợ cũ</td>`; newRow.innerHTML = `${nameCellHTML}<td colspan="2"><input type="text" class="dynamic-input" style="color: ${isBonus ? 'var(--success-color)' : 'var(--danger-color)'};" data-type="${type}" placeholder="Nhập số tiền..." inputmode="numeric"></td>`; const anchorRow = document.getElementById('extraBonusRow') || mainBonusRow; anchorRow.insertAdjacentElement('afterend', newRow); const input = newRow.querySelector('input'); input.addEventListener('input', handleDynamicInputChange); input.addEventListener('focus', (e) => e.target.value = (parseFloat(e.target.dataset.fullValue) || 0).toLocaleString('vi-VN')); input.addEventListener('blur', (e) => e.target.value = formatNumberHiddenK(e.target.dataset.fullValue || '0')); input.focus(); } 
        function handleDynamicInputChange(e) { const input = e.target; const rawValue = input.value.replace(/[^\d-]/g, ''); const num = parseInt(rawValue, 10) || 0; input.dataset.fullValue = num; input.value = num.toLocaleString('vi-VN'); /* Show full value while typing */ if (input.dataset.type === 'bonus') state.extraBonus = num; else if (input.dataset.type === 'debt') state.extraDebt = num; updateDetailedReportView(); }
        
        function handleSellOptionsChange(event) {
            const ticketType = document.querySelector('input[name="sellTicketType"]:checked').value;
            const priceType = document.querySelector('input[name="sellPrice"]:checked').value;
            const commissionType = document.querySelector('input[name="commissionRate"]:checked').value;
            DOM.customTicketName.style.display = ticketType === 'custom-name' ? 'block' : 'none';
            DOM.customTicketPrice.style.display = priceType === 'custom-price' ? 'block' : 'none';
            DOM.customCommissionPercent.style.display = commissionType === 'custom-commission' ? 'block' : 'none';
            if (event && event.isTrusted && event.target.name === 'sellTicketType') {
                DOM.sellQuantityInput.value = '';
                switch (ticketType) {
                    case 'xo-so': document.querySelector('input[name="sellPrice"][value="10000"]').checked = true; document.querySelector('input[name="commissionRate"][value="0.10"]').checked = true; DOM.customTicketPrice.style.display = 'none'; DOM.customCommissionPercent.style.display = 'none'; DOM.sellQuantityInput.focus(); break;
                    case 've-boc': document.querySelector('input[name="sellPrice"][value="5000"]').checked = true; document.querySelector('input[name="commissionRate"][value="0.12"]').checked = true; DOM.customTicketPrice.style.display = 'none'; DOM.customCommissionPercent.style.display = 'none'; DOM.sellQuantityInput.focus(); break;
                    case 'custom-name': DOM.customTicketName.focus(); break;
                }
            }
        }
        function addTicketToReport() { if (!state.currentSoSo) { showNotification("Vui lòng tạo hoặc mở một báo cáo chi tiết trước khi thêm vé!", 'error'); return; } const quantity = parseInt(DOM.sellQuantityInput.value, 10); if (!quantity || quantity <= 0) { showNotification("Vui lòng nhập số lượng vé hợp lệ!", 'error'); return; } let typeName = ''; const ticketType = document.querySelector('input[name="sellTicketType"]:checked').value; if (ticketType === 'xo-so') { typeName = 'Xổ số'; } else if (ticketType === 've-boc') { typeName = 'Vé bóc'; } else { typeName = DOM.customTicketName.value.trim(); if (!typeName) { showNotification('Vui lòng nhập tên loại hình!', 'error'); return; } } let price = 0; const priceType = document.querySelector('input[name="sellPrice"]:checked').value; if (priceType === 'custom-price') { price = parseFloat(DOM.customTicketPrice.value.replace(/\D/g, '')) || 0; if (price <= 0) { showNotification('Vui lòng nhập giá bán hợp lệ!', 'error'); return; } } else { price = parseFloat(priceType); } let commissionRate = 0; const commissionType = document.querySelector('input[name="commissionRate"]:checked').value; if (commissionType === 'custom-commission') { commissionRate = parseFloat(DOM.customCommissionPercent.value) / 100 || 0; if (commissionRate <= 0) { showNotification('Vui lòng nhập % hoa hồng hợp lệ!', 'error'); return; } } else { commissionRate = parseFloat(commissionType); } const doanhThu = quantity * price; const hoaHong = doanhThu * commissionRate; const formattedName = `${typeName} (${(price / 1000).toLocaleString('vi-VN')}k) [${quantity} vé]`; const newTicket = { id: Date.now(), doanhThu, hoaHong, name: formattedName }; state.addedTickets.push(newTicket); const newRow = document.createElement('tr'); newRow.className = 'added-ticket-row'; newRow.dataset.ticketId = newTicket.id; newRow.innerHTML = `<td>${newTicket.name}</td><td>${formatNumberHiddenK(doanhThu)}</td><td>${formatCommissionCellHiddenK(doanhThu, hoaHong)}</td>`; const tongCongRow = document.getElementById('tongCongRow'); if (!tongCongRow) { showNotification('Lỗi: Không tìm thấy bảng báo cáo để thêm vé.', 'error'); return; } tongCongRow.parentNode.insertBefore(newRow, tongCongRow); updateDetailedReportView(); DOM.sellQuantityInput.value = ''; newRow.scrollIntoView({ behavior: 'smooth', block: 'center' }); showSection('reportSection'); showNotification('Đã thêm vé vào báo cáo!', 'success'); }
        
        // === THÊM MỚI: Các hàm quản lý khóa mật khẩu ===
        function lockRegions() {
            DOM.regionDefinitionsInput.disabled = true;
            DOM.btnSaveRegions.textContent = 'Mở khoá Định nghĩa';
            DOM.btnSaveRegions.classList.remove('success');
            DOM.btnSaveRegions.classList.add('warning');
            isRegionLocked = true;
        }

        function unlockRegions() {
            DOM.regionDefinitionsInput.disabled = false;
            DOM.btnSaveRegions.textContent = 'Lưu Định nghĩa';
            DOM.btnSaveRegions.classList.remove('warning');
            DOM.btnSaveRegions.classList.add('success');
            isRegionLocked = false;
            DOM.regionDefinitionsInput.focus();
        }

        function showPasswordModal() {
            DOM.passwordInput.value = '';
            DOM.passwordModal.style.display = 'block';
            DOM.passwordInput.focus();
        }

        function hidePasswordModal() {
            DOM.passwordModal.style.display = 'none';
        }

        function checkPassword() {
            const pass = DOM.passwordInput.value;
            // === THAY ĐỔI: Mật khẩu là "admin" ===
            if (pass === 'admin') {
                hidePasswordModal();
                unlockRegions();
                showNotification('Đã mở khoá. Bạn có thể chỉnh sửa.', 'success');
            } else {
                showNotification('Mật khẩu không đúng!', 'error');
                DOM.passwordInput.value = '';
                DOM.passwordInput.focus();
            }
        }

        function handleRegionButtonPress() {
            if (isRegionLocked) {
                showPasswordModal();
            } else {
                // Đây là hành động "Lưu"
                parseAndSaveRegions(false); 
            }
        }
        // === KẾT THÚC THÊM MỚI ===

        // === THAY ĐỔI: Hàm tải định nghĩa vùng từ localStorage ===
        function loadSavedRegions() {
            try {
                const savedDefinitions = localStorage.getItem('zengAppRegionDefinitions');
                // === THAY ĐỔI: Kiểm tra nếu có dữ liệu thì mới khoá ===
                if (savedDefinitions && savedDefinitions.trim() !== '') { 
                    DOM.regionDefinitionsInput.value = savedDefinitions;
                    parseAndSaveRegions(true); // true = silent mode (không hiển thị thông báo)
                    lockRegions(); // <-- Khoá lại khi tải
                } else {
                    unlockRegions(); // <-- Mở nếu không có gì
                }
            } catch (error) {
                console.error("Lỗi khi tải từ localStorage:", error);
                showNotification('Không thể tải định nghĩa đã lưu.', 'error');
                unlockRegions(); // Mở khoá nếu có lỗi
            }
        }
        // === KẾT THÚC THAY ĐỔI ===

        // === THAY ĐỔI: Hàm lưu và phân tích Định nghĩa Vùng (thêm silent và localStorage) ===
        function parseAndSaveRegions(silent = false) {
            const text = DOM.regionDefinitionsInput.value;
            regionDefinitions = {}; // Xóa định nghĩa cũ
            
            // Xóa các option cũ (giữ lại option "Tất cả")
            while (DOM.regionSelect.options.length > 1) {
                DOM.regionSelect.remove(1);
            }

            const lines = text.split('\n');
            let regionsAdded = 0;

            lines.forEach(line => {
                const colonIndex = line.indexOf(':');
                if (colonIndex > 0) { // Phải có dấu : và tên vùng không được rỗng
                    const name = line.substring(0, colonIndex).trim();
                    const rulesString = line.substring(colonIndex + 1).trim();
                    
                    if (name && rulesString) {
                        const parsedRules = parseFilterString(rulesString);
                        if (parsedRules) {
                            regionDefinitions[name] = parsedRules;
                            
                            // Thêm vào dropdown
                            const option = document.createElement('option');
                            option.value = name;
                            option.textContent = name;
                            DOM.regionSelect.appendChild(option);
                            regionsAdded++;
                        }
                    }
                }
            });

            // === THÊM MỚI: Lưu vào localStorage ===
            try {
                localStorage.setItem('zengAppRegionDefinitions', text);
            } catch (error) {
                console.error("Lỗi khi lưu vào localStorage:", error);
                if (!silent) {
                    showNotification('Không thể lưu định nghĩa vĩnh viễn (lỗi trình duyệt).', 'error');
                }
                return; // Dừng nếu không lưu được
            }
            // === KẾT THÚC THÊM MỚI ===

            if (!silent) { // Chỉ hiển thị thông báo nếu không ở chế độ 'silent'
                if (regionsAdded > 0) {
                    showNotification(`Đã lưu thành công ${regionsAdded} vùng.`, 'success');
                } else {
                    showNotification('Không tìm thấy định nghĩa vùng hợp lệ.', 'info');
                }
                
                // === THÊM MỚI: Tự động khoá lại sau khi lưu ===
                if (text.trim() !== '') {
                    lockRegions();
                } else {
                    unlockRegions(); // Nếu lưu rỗng thì mở khoá
                }
            }
        }
        // === KẾT THÚC THAY ĐỔI ===

        // --- UTILITY FUNCTIONS ---

        // === HÀM MỚI: Để lưu ảnh về máy ===
        async function saveElementAsImage(selector, filename, buttonElement = null) {
            const element = document.querySelector(selector);
            if (!element || !element.innerHTML.trim()) {
                showNotification("Chưa có nội dung để lưu!", 'info');
                return;
            }

            const originalButtonText = buttonElement ? buttonElement.textContent : '';
            if (buttonElement) buttonElement.textContent = 'Đang tạo ảnh...';

            // Ẩn các nút điều khiển
            const elementsToHideTemporarily = [];
            const actions = element.querySelector('.summary-actions'); 
            const filterControls = element.querySelector('.controls-panel'); // <-- THÊM MỚI: Ẩn cả bộ lọc
            const reportActions = document.getElementById('actionButtonContainer'); 
            if (actions) elementsToHideTemporarily.push(actions);
            if (filterControls) elementsToHideTemporarily.push(filterControls); // <-- THÊM MỚI
            if (reportActions && element === DOM.reportContainer) elementsToHideTemporarily.push(reportActions);
            
            // === CẬP NHẬT: Dùng display: none thay vì visibility: hidden ===
            elementsToHideTemporarily.forEach(el => el.style.display = 'none');
            
            const copyright = document.getElementById('copyrightInReport');
            if (copyright && element === DOM.reportContainer) copyright.style.display = 'block'; 

            // === CẬP NHẬT: Xử lý chụp nội dung cuộn (Logic mới) ===
            let mainPage, tableContainer, table, summarySectionEl;
            let originalPageMaxWidth, originalSummarySectionWidth, originalTableContainerWidth, originalTableContainerOverflow;

            if (selector === '#summarySection') {
                mainPage = DOM.mainPage;
                summarySectionEl = DOM.summarySection;
                tableContainer = DOM.summaryTableContainer;
                table = tableContainer.querySelector('table');
                
                if (mainPage && summarySectionEl && tableContainer && table) {
                    originalPageMaxWidth = mainPage.style.maxWidth;
                    originalSummarySectionWidth = summarySectionEl.style.width;
                    originalTableContainerWidth = tableContainer.style.width;
                    originalTableContainerOverflow = tableContainer.style.overflowX;

                    mainPage.style.maxWidth = 'none';
                    const scrollW = table.scrollWidth + 2; // +2px buffer
                    
                    summarySectionEl.style.width = `${scrollW}px`;
                    tableContainer.style.width = `${scrollW}px`;
                    tableContainer.style.overflowX = 'visible';
                }
            }
            // === KẾT THÚC CẬP NHẬT ===


            // === CẬP NHẬT: Thêm setTimeout để chờ trình duyệt vẽ lại ===
            setTimeout(async () => {
                try {
                    const canvas = await html2canvas(element, { backgroundColor: "#ffffff", scale: 2 });
                    const dataUrl = canvas.toDataURL('image/png');
                    
                    const link = document.createElement('a');
                    link.href = dataUrl;
                    link.download = filename; 
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    showNotification('Đã lưu ảnh thành công!', 'success');
                    if (buttonElement) {
                        buttonElement.textContent = 'Đã lưu!';
                        setTimeout(() => { if(buttonElement) buttonElement.textContent = originalButtonText; }, 2000);
                    }

                } catch (err) {
                    console.error('Lỗi tạo ảnh:', err);
                    showNotification('Đã xảy ra lỗi khi tạo ảnh.', 'error');
                    if (buttonElement) buttonElement.textContent = originalButtonText;
                } finally {
                    // Hiển thị lại các nút đã ẩn
                    if (copyright) copyright.style.display = 'none';
                    // === CẬP NHẬT: Khôi phục display ===
                    elementsToHideTemporarily.forEach(el => el.style.display = ''); 

                    // === CẬP NHẬT: Khôi phục cài đặt cuộn (bên trong finally) ===
                    if (mainPage && summarySectionEl && tableContainer) {
                        mainPage.style.maxWidth = originalPageMaxWidth;
                        summarySectionEl.style.width = originalSummarySectionWidth;
                        tableContainer.style.width = originalTableContainerWidth;
                        tableContainer.style.overflowX = originalTableContainerOverflow;
                    }
                    // === KẾT THÚC CẬP NHẬT ===
                }
            }, 50); // <-- Đợi 50ms
        }
        
        async function copyElementAsImage(selector, message, buttonElement = null) {
            const element = document.querySelector(selector);
            if (!element || !element.innerHTML.trim()) return showNotification("Chưa có nội dung để sao chép!", 'info');
            const originalButtonText = buttonElement ? buttonElement.textContent : '';
            if (buttonElement) buttonElement.textContent = 'Đang tạo ảnh...';
            const elementsToHideTemporarily = [];
            const actions = element.querySelector('.summary-actions'); 
            const filterControls = element.querySelector('.controls-panel'); // <-- THÊM MỚI: Ẩn cả bộ lọc
            const reportActions = document.getElementById('actionButtonContainer'); 
            if (actions) elementsToHideTemporarily.push(actions);
            if (filterControls) elementsToHideTemporarily.push(filterControls); // <-- THÊM MỚI
            if (reportActions && element === DOM.reportContainer) elementsToHideTemporarily.push(reportActions);

            // === CẬP NHẬT: Dùng display: none thay vì visibility: hidden ===
            elementsToHideTemporarily.forEach(el => el.style.display = 'none');
            
            const copyright = document.getElementById('copyrightInReport');
            if (copyright && element === DOM.reportContainer) copyright.style.display = 'block'; 

            // === CẬP NHẬT: Xử lý chụp nội dung cuộn (Logic mới) ===
            let mainPage, tableContainer, table, summarySectionEl;
            let originalPageMaxWidth, originalSummarySectionWidth, originalTableContainerWidth, originalTableContainerOverflow;

            if (selector === '#summarySection') {
                mainPage = DOM.mainPage;
                summarySectionEl = DOM.summarySection;
                tableContainer = DOM.summaryTableContainer;
                table = tableContainer.querySelector('table');
                
                if (mainPage && summarySectionEl && tableContainer && table) {
                    originalPageMaxWidth = mainPage.style.maxWidth;
                    originalSummarySectionWidth = summarySectionEl.style.width;
                    originalTableContainerWidth = tableContainer.style.width;
                    originalTableContainerOverflow = tableContainer.style.overflowX;

                    mainPage.style.maxWidth = 'none';
                    const scrollW = table.scrollWidth + 2; // +2px buffer
                    
                    summarySectionEl.style.width = `${scrollW}px`;
                    tableContainer.style.width = `${scrollW}px`;
                    tableContainer.style.overflowX = 'visible';
                }
            }
            // === KẾT THÚC CẬP NHẬT ===

            // === CẬP NHẬT: Thêm setTimeout để chờ trình duyệt vẽ lại ===
            setTimeout(async () => {
                try {
                    const canvas = await html2canvas(element, { backgroundColor: "#ffffff", scale: 2 });
                    canvas.toBlob(async (blob) => {
                        try {
                            if (navigator.clipboard && navigator.clipboard.write) {
                                await navigator.clipboard.write([ new ClipboardItem({ 'image/png': blob }) ]);
                                showNotification(message, 'success');
                                if (buttonElement) {
                                    buttonElement.textContent = 'Đã Copy!';
                                    setTimeout(() => { if(buttonElement) buttonElement.textContent = originalButtonText; }, 2000);
                                }
                            } else { throw new Error('Clipboard API không được hỗ trợ.'); }
                        } catch (writeErr) {
                            console.error('Lỗi khi dùng navigator.clipboard.write:', writeErr);
                            showNotification('Không thể tự động copy, vui lòng copy thủ công!', 'info');
                            DOM.imagePreviewHolder.src = canvas.toDataURL('image/png');
                            DOM.imagePreviewModal.style.display = 'block';
                            if (buttonElement) buttonElement.textContent = originalButtonText;
                        }
                    }, 'image/png');
                } catch (err) {
                    console.error('Lỗi tạo ảnh:', err);
                    showNotification('Đã xảy ra lỗi khi tạo ảnh.', 'error');
                    if (buttonElement) buttonElement.textContent = originalButtonText;
                } finally {
                    if (copyright) copyright.style.display = 'none';
                    // === CẬP NHẬT: Khôi phục display ===
                    elementsToHideTemporarily.forEach(el => el.style.display = ''); 

                    // === CẬP NHẬT: Khôi phục cài đặt cuộn (bên trong finally) ===
                    if (mainPage && summarySectionEl && tableContainer) {
                        mainPage.style.maxWidth = originalPageMaxWidth;
                        summarySectionEl.style.width = originalSummarySectionWidth;
                        tableContainer.style.width = originalTableContainerWidth;
                        tableContainer.style.overflowX = originalTableContainerOverflow;
                    }
                    // === KẾT THÚC CẬP NHẬT ===
                }
            }, 50); // <-- Đợi 50ms
        }
        
        // === THÊM MỚI: Hàm format số đầy đủ ===
        function formatNumberFull(num) { 
            num = parseFloat(num); 
            if (isNaN(num) || num === 0) return "0"; 
            return parseInt(num).toLocaleString("vi-VN"); 
        }
        
        function formatNumberHiddenK(num) { num = parseFloat(num); if (isNaN(num) || num === 0 || Math.abs(num) < 1000) return "0"; return parseInt(num / 1000).toLocaleString("vi-VN"); }
        function formatCommissionCellHiddenK(revenue, commission) { revenue = parseFloat(revenue); commission = parseFloat(commission); if (!revenue || revenue === 0 || isNaN(revenue) || isNaN(commission)) return formatNumberHiddenK(commission); const percentage = Math.round((commission / revenue) * 100); return `<i style="color: #E57373; font-weight: normal;">(${percentage}%)</i> ${formatNumberHiddenK(commission)}`; }
        
        // === THÊM MỚI: Hàm xử lý lọc ===
        function parseFilterString(filterString) {
            if (!filterString || filterString.trim() === '') {
                return null; // Không có bộ lọc
            }

            const rules = [];
            const parts = filterString.split('+'); // Tách bằng dấu +
            
            parts.forEach(part => {
                part = part.trim();
                if (!part) return;

                // === THAY ĐỔI: Sử dụng '_' thay vì '.' ===
                if (part.includes('_')) {
                    // Đây là một khoảng, ví dụ: "550_599"
                    const range = part.split('_');
                    const min = parseInt(range[0], 10);
                    const max = parseInt(range[1], 10);
                    if (!isNaN(min) && !isNaN(max) && min <= max) {
                        rules.push({ min, max });
                    }
                } else {
                    // Đây là một số đơn, ví dụ: "6999"
                    const num = parseInt(part, 10);
                    if (!isNaN(num)) {
                        rules.push({ min: num, max: num });
                    }
                }
            });
            
            return rules.length > 0 ? rules : null;
        }

        function agentMatchesFilter(agentCode, filterRules) {
            if (!filterRules) {
                return true; // Nếu không có quy tắc, tất cả đều khớp
            }

            // Lấy phần số của agentCode, ví dụ "550" từ "DL 550" hoặc "550"
            const numericMatch = String(agentCode).match(/\d+$/);
            if (!numericMatch) {
                return false; // Mã đại lý không có số, không thể lọc
            }
            const agentNum = parseInt(numericMatch[0], 10);

            // Kiểm tra xem số đại lý có khớp với BẤT KỲ quy tắc nào không
            for (const rule of filterRules) {
                if (agentNum >= rule.min && agentNum <= rule.max) {
                    return true; // Khớp một quy tắc
                }
            }
            
            return false; // Không khớp quy tắc nào
        }
        // === KẾT THÚC THÊM MỚI ===

        function docso(numberStr) {
            const num = String(numberStr).replace(/[.,]/g, '');
            if (num === '0') return 'Không';
            if (num === '' || isNaN(parseInt(num))) return '';
            const words = ["không", "một", "hai", "ba", "bốn", "năm", "sáu", "bảy", "tám", "chín"];
            const units = ["", "nghìn", "triệu", "tỷ"];
            const readChunk = (chunkStr, isFirstChunk) => {
                if (!chunkStr || parseInt(chunkStr, 10) === 0) return "";
                let n = chunkStr.padStart(3, '0').split('').map(Number);
                if (chunkStr.length < 3 && isFirstChunk) { 
                    if (chunkStr.length === 1) n = [0, 0, Number(chunkStr)];
                    else if (chunkStr.length === 2) n = [0, Number(chunkStr[0]), Number(chunkStr[1])];
                }
                const [tram, chuc, donvi] = n; let str = "";
                if (tram > 0) { str += words[tram] + " trăm "; } 
                else if (!isFirstChunk && (chuc > 0 || donvi > 0)) { str += "không trăm "; }
                if (chuc === 0 && donvi !== 0) { if (tram > 0 || !isFirstChunk) str += "linh "; } 
                else if (chuc === 1) { str += "mười "; } 
                else if (chuc > 1) { str += words[chuc] + " mươi "; }
                if (donvi > 0) {
                     if (chuc === 0) {
                         if((tram > 0 || !isFirstChunk) && parseInt(chunkStr, 10) > 0) str += words[donvi]; 
                         else if (isFirstChunk) str+= words[donvi]; 
                     }
                     else if (chuc === 1) { 
                        if (donvi === 1) str += "một"; 
                        else if (donvi === 5) str += "lăm"; 
                        else str += words[donvi];
                    } else { 
                        if (donvi === 1) str += "mốt"; 
                        else if (donvi === 5) str += "lăm"; 
                        else str += words[donvi];
                    }
                }
                return str.trim();
            };
            const chunks = []; let tempNum = num;
            while (tempNum.length > 0) { chunks.unshift(tempNum.substring(Math.max(0, tempNum.length - 3))); tempNum = tempNum.substring(0, tempNum.length - 3); }
            if (chunks.length > units.length) return "Số quá lớn";
            let result = chunks.map((chunk, i) => { const text = readChunk(chunk, i === 0); if (text) { return text + " " + units[chunks.length - 1 - i]; } return ""; }).filter(Boolean).join(" ").replace(/\s+/g, ' ').trim();
            return result.charAt(0).toUpperCase() + result.slice(1);
        }
        
        // --- Notification System ---
        function showNotification(message, type = 'info', duration = 3000) { const notification = document.createElement('div'); notification.className = `notification ${type}`; notification.textContent = message; DOM.notificationArea.appendChild(notification); notification.offsetHeight; notification.classList.add('show'); setTimeout(() => { notification.classList.remove('show'); notification.addEventListener('transitionend', () => notification.remove()); }, duration); }

        // --- Loading Indicator ---
        function showLoading() { DOM.loadingIndicator.style.display = 'block'; }
        function hideLoading() { DOM.loadingIndicator.style.display = 'none'; }
        
        document.addEventListener('DOMContentLoaded', initializeApp);

    })();
  </script>

</body>
</html>
