<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Player To√†n Di·ªán</title>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f9;
        }
        h1, h2 {
            color: #333;
        }
        #fileInput {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            display: block;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 15px;
        }
        /* Playlist Styles */
        #playlist-container {
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
            margin-top: 10px;
        }
        #playlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        #playlist-header h2 {
            margin: 0;
            font-size: 1.2em;
        }
        #playlist {
            list-style: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
        }
        #playlist li {
            padding: 8px 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
            word-break: break-all;
            display: flex; 
            align-items: center;
            justify-content: space-between;
        }
        #playlist li:last-child {
            border-bottom: none;
        }
        .track-info {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        span.track-index {
            width: 30px;
            font-weight: bold;
            color: #888;
            margin-right: 10px;
            text-align: right;
        }
        .active-track {
            background-color: #007bff !important;
            color: white;
            font-weight: bold;
        }
        .active-track span.track-index {
            color: white; 
        }
        .track-actions button {
            background: none;
            border: none;
            cursor: pointer;
            color: #555;
            font-size: 14px;
            margin-left: 5px;
            padding: 2px 5px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .active-track .track-actions button {
            color: white;
        }
        .track-actions button:hover {
            opacity: 1;
        }

        /* Player Controls Styles */
        #playerContainer {
            margin-top: 15px;
        }
        #playerContainer audio, #playerContainer video {
            width: 100%;
            height: auto;
            display: block;
        }
        #controls {
            padding: 15px 0;
            background-color: #e9ecef;
            border-radius: 5px;
            margin-top: 10px;
        }
        #topControls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        #topControls button, #extraControls button {
            padding: 10px 15px;
            cursor: pointer;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        .active-mode {
            background-color: #007bff !important;
        }
        
        /* Volume and Time Controls */
        #volumeAndTimeControls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            margin-top: 10px;
        }
        #volumeControls {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #volumeSlider {
            width: 80px;
        }
        #timeControls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-grow: 1;
            padding: 0 15px;
        }
        #progressBar {
            flex-grow: 1;
            height: 8px;
            cursor: pointer;
        }
        #visualizer {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 40px;
            gap: 2px;
            margin-top: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        .bar {
            width: 3px;
            background-color: #007bff;
            animation: bounce 0.6s infinite alternate;
        }
        @keyframes bounce {
            0% { height: 5px; }
            100% { height: 35px; }
        }
        #footer {
            margin-top: 30px;
            text-align: center;
            font-size: 0.8em;
            color: #777;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <h1>üé¨ Web Player To√†n Di·ªán</h1>

    <input 
        type="file" 
        id="fileInput" 
        accept="audio/*, video/*, .m3u" 
        multiple 
        webkitdirectory
    >

    <hr>

    <h2>Tr√¨nh ph√°t & ƒêi·ªÅu khi·ªÉn</h2>
    <div id="playerContainer">
        </div>

    <div id="visualizer"></div>
    
    <div id="controls">
        <div id="topControls">
            <button id="prevBtn" disabled>‚èÆÔ∏è</button>
            <button id="playPauseBtn">‚ñ∂Ô∏è</button>
            <button id="nextBtn" disabled>‚è≠Ô∏è</button>
        </div>

        <div id="timeControls">
            <span id="timeDisplay">0:00 / 0:00</span>
            <input type="range" id="progressBar" min="0" max="0" step="0.1" value="0">
        </div>

        <div id="volumeAndTimeControls">
            <div id="volumeControls">
                <button id="muteBtn">üîä</button>
                <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="1">
                <span id="currentVolume">100%</span>
            </div>

            <div id="extraControls">
                <button id="shuffleBtn" title="Tr·ªôn danh s√°ch">üîÄ</button>
                <button id="repeatBtn" title="Ch·∫ø ƒë·ªô l·∫∑p l·∫°i: T·∫Øt">üîÅ</button>
            </div>
        </div>
    </div>
    
    <p id="currentTrack">Ch∆∞a c√≥ b√†i n√†o ƒëang ph√°t.</p>

    <hr>

    <div id="playlist-container">
        <div id="playlist-header">
            <h2>Danh s√°ch ph√°t</h2>
            <button onclick="clearAllTracks()" title="X√≥a to√†n b·ªô danh s√°ch">üóëÔ∏è X√≥a t·∫•t c·∫£</button>
        </div>
        <ul id="playlist">
            <li id="empty-message">Vui l√≤ng ch·ªçn **th∆∞ m·ª•c** ho·∫∑c **file .m3u** ƒë·ªÉ th√™m v√†o danh s√°ch.</li>
        </ul>
    </div>

    <div id="footer">
        ¬© 2025 ZENG FINANCE
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UI Elements ---
            const fileInput = document.getElementById('fileInput');
            const playlistElement = document.getElementById('playlist');
            const playerContainer = document.getElementById('playerContainer');
            const currentTrackDisplay = document.getElementById('currentTrack');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const volumeSlider = document.getElementById('volumeSlider');
            const currentVolumeDisplay = document.getElementById('currentVolume');
            const muteBtn = document.getElementById('muteBtn');
            const progressBar = document.getElementById('progressBar');
            const timeDisplay = document.getElementById('timeDisplay');
            const shuffleBtn = document.getElementById('shuffleBtn');
            const repeatBtn = document.getElementById('repeatBtn');
            const visualizer = document.getElementById('visualizer');

            // --- State Variables ---
            let allFiles = {}; 
            let trackList = []; 
            let currentTrackIndex = -1;
            let currentVolume = 1.0;
            let isMuted = false;
            let mediaPlayer = null;
            let isDraggingSlider = false;

            let repeatMode = 0; 
            let isShuffled = false;
            let shuffleHistory = []; 

            // --- 0. Helper Functions ---
            function formatTime(seconds) {
                if (isNaN(seconds)) return '0:00';
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.floor(seconds % 60);
                return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
            }

            function updateTimeDisplay(currentTime, duration) {
                timeDisplay.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
            }
            
            // --- H√ÄM KI·ªÇM TRA MEDIA FILE H·ª¢P L·ªÜ (ƒê√£ s·ª≠a l·ªói MP4) ---
            function isMediaFile(file) {
                if (!file) return false;
                const fileName = file.name.toLowerCase();
                const isMediaByMimeType = file.type.startsWith('audio/') || file.type.startsWith('video/');
                
                // Ki·ªÉm tra theo ƒëu√¥i m·ªü r·ªông ph·ªï bi·∫øn
                const isMediaByExtension = fileName.endsWith('.mp3') || fileName.endsWith('.wav') || fileName.endsWith('.m4a') || 
                                           fileName.endsWith('.mp4') || fileName.endsWith('.webm') || fileName.endsWith('.ogg') || 
                                           fileName.endsWith('.mov') || fileName.endsWith('.avi');
                
                return isMediaByMimeType || isMediaByExtension;
            }

            // --- Visualizer Setup ---
            const NUM_BARS = 32;
            let bars = [];
            for (let i = 0; i < NUM_BARS; i++) {
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.animationDelay = `${(i * 0.02) - (NUM_BARS * 0.02)}s`;
                bar.style.animationDuration = `${0.6 + (Math.random() * 0.4)}s`;
                visualizer.appendChild(bar);
                bars.push(bar);
            }

            function toggleVisualizer(isPlaying) {
                bars.forEach(bar => {
                    bar.style.animationPlayState = isPlaying ? 'running' : 'paused';
                    bar.style.backgroundColor = isPlaying ? '#007bff' : '#ccc';
                    if (!isPlaying) {
                        setTimeout(() => {
                            bars.forEach(bar => bar.style.height = '5px');
                        }, 600);
                    }
                });
            }

            // --- 1. Player Creation & Setup ---
            function createPlayerElement(isAudio = true) {
                playerContainer.innerHTML = ''; 
                const player = isAudio ? document.createElement('audio') : document.createElement('video');
                player.id = 'mediaPlayer';
                player.controls = false; 
                player.autoplay = true;
                player.volume = currentVolume; 
                player.muted = isMuted;
                
                player.addEventListener('ended', handleTrackEnd);
                player.addEventListener('volumechange', handleVolumeChange);
                player.addEventListener('loadedmetadata', setupProgressBar);
                player.addEventListener('timeupdate', updateProgressBar);
                player.addEventListener('play', () => { 
                    playPauseBtn.textContent = '‚è∏Ô∏è'; 
                    toggleVisualizer(true);
                });
                player.addEventListener('pause', () => { 
                    playPauseBtn.textContent = '‚ñ∂Ô∏è';
                    toggleVisualizer(false);
                });
                
                playerContainer.appendChild(player);
                return player;
            }
            
            volumeSlider.value = currentVolume;
            currentVolumeDisplay.textContent = `${Math.round(currentVolume * 100)}%`;
            toggleVisualizer(false);

            // --- 2. Controls ---
            
            function handleVolumeChange() {
                if (mediaPlayer) {
                    currentVolume = mediaPlayer.volume;
                    isMuted = mediaPlayer.muted;
                    volumeSlider.value = currentVolume;
                    currentVolumeDisplay.textContent = `${Math.round(currentVolume * 100)}%`;
                    muteBtn.textContent = isMuted ? 'üîá' : 'üîä';
                }
            }
            volumeSlider.addEventListener('input', (event) => {
                currentVolume = parseFloat(event.target.value);
                currentVolumeDisplay.textContent = `${Math.round(currentVolume * 100)}%`;
                if (mediaPlayer) {
                    mediaPlayer.volume = currentVolume;
                    if (currentVolume > 0 && mediaPlayer.muted) {
                        mediaPlayer.muted = false;
                        isMuted = false;
                        muteBtn.textContent = 'üîä';
                    } else if (currentVolume === 0 && !mediaPlayer.muted) {
                        mediaPlayer.muted = true;
                        isMuted = true;
                        muteBtn.textContent = 'üîá';
                    }
                }
            });
            muteBtn.addEventListener('click', () => {
                if (!mediaPlayer) return;
                isMuted = !isMuted;
                mediaPlayer.muted = isMuted;
                muteBtn.textContent = isMuted ? 'üîá' : 'üîä';
            });
            playPauseBtn.addEventListener('click', () => {
                if (!mediaPlayer) return;
                if (mediaPlayer.paused) {
                    mediaPlayer.play();
                } else {
                    mediaPlayer.pause();
                }
            });
            function setupProgressBar() {
                if (!mediaPlayer) return;
                progressBar.max = mediaPlayer.duration;
                updateTimeDisplay(mediaPlayer.currentTime, mediaPlayer.duration);
            }
            function updateProgressBar() {
                if (!mediaPlayer || isDraggingSlider) return;
                progressBar.value = mediaPlayer.currentTime;
                updateTimeDisplay(mediaPlayer.currentTime, mediaPlayer.duration);
            }
            progressBar.addEventListener('mousedown', () => isDraggingSlider = true);
            progressBar.addEventListener('mouseup', () => {
                isDraggingSlider = false;
                if (mediaPlayer) {
                    mediaPlayer.currentTime = parseFloat(progressBar.value);
                }
            });
            progressBar.addEventListener('input', () => {
                if (mediaPlayer) {
                    updateTimeDisplay(parseFloat(progressBar.value), mediaPlayer.duration);
                }
            });
            
            // --- 3. Shuffle and Repeat Logic ---
            
            function toggleRepeat() {
                repeatMode = (repeatMode + 1) % 3;
                
                if (repeatMode === 0) {
                    repeatBtn.textContent = 'üîÅ';
                    repeatBtn.classList.remove('active-mode');
                    repeatBtn.title = 'L·∫∑p l·∫°i: T·∫Øt';
                } else if (repeatMode === 1) {
                    repeatBtn.textContent = 'üîÇ';
                    repeatBtn.classList.add('active-mode');
                    repeatBtn.title = 'L·∫∑p l·∫°i: B√†i h√°t hi·ªán t·∫°i';
                } else if (repeatMode === 2) {
                    repeatBtn.textContent = 'üîÑ';
                    repeatBtn.classList.add('active-mode');
                    repeatBtn.title = 'L·∫∑p l·∫°i: To√†n b·ªô danh s√°ch';
                }
            }
            repeatBtn.addEventListener('click', toggleRepeat);

            function toggleShuffle() {
                isShuffled = !isShuffled;
                shuffleBtn.classList.toggle('active-mode', isShuffled);
                shuffleBtn.title = isShuffled ? 'Tr·ªôn: ƒêang b·∫≠t (Ng·∫´u nhi√™n)' : 'Tr·ªôn: ƒêang t·∫Øt (Tu·∫ßn t·ª±)';

                shuffleHistory = [];
                if (currentTrackIndex !== -1) {
                    shuffleHistory.push(currentTrackIndex);
                }
                
                updateControls();
            }
            shuffleBtn.addEventListener('click', toggleShuffle);


            function handleTrackEnd() {
                if (repeatMode === 1) {
                    playTrack(currentTrackIndex);
                    return;
                }
                playNextTrack(); 
            }

            // --- 4. File/Folder Loading (ƒê√£ S·ª≠a L·ªói) ---
            
            window.clearAllTracks = function() {
                trackList = [];
                currentTrackIndex = -1;
                allFiles = {};
                shuffleHistory = [];

                if (mediaPlayer) mediaPlayer.pause();
                playlistElement.innerHTML = '<li id="empty-message">Vui l√≤ng ch·ªçn **th∆∞ m·ª•c** ho·∫∑c **file .m3u** ƒë·ªÉ th√™m v√†o danh s√°ch.</li>';
                currentTrackDisplay.textContent = 'Ch∆∞a c√≥ b√†i n√†o ƒëang ph√°t.';
                updateTimeDisplay(0, 0);
                progressBar.max = 0;
                progressBar.value = 0;
                updateControls();
                toggleVisualizer(false);
            }

            fileInput.addEventListener('change', (event) => {
                const files = event.target.files;
                if (files.length > 0) {
                    allFiles = {};
                    let m3uFile = null;

                    for (const file of files) {
                        const relativePath = file.webkitRelativePath || file.name;
                        allFiles[relativePath] = file;

                        if (file.name.toLowerCase().endsWith('.m3u')) {
                            if (!m3uFile) m3uFile = file;
                        }
                    }
                    
                    const allMediaFiles = Object.values(allFiles).filter(file => isMediaFile(file));

                    trackList = []; 
                    shuffleHistory = [];

                    if (m3uFile) {
                        readM3U(m3uFile);
                    } else {
                        trackList = allMediaFiles;
                        
                        updatePlaylistUI();
                        if (trackList.length > 0) playTrack(0);
                    }
                }
            });

            function readM3U(m3uFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    const lines = content.split('\n');
                    
                    trackList = [];
                    const m3uDir = m3uFile.webkitRelativePath ? m3uFile.webkitRelativePath.substring(0, m3uFile.webkitRelativePath.lastIndexOf('/')) : '';

                    for (const line of lines) {
                        if (line.trim() === '' || line.startsWith('#')) continue;

                        let trackPath = line.trim();
                        let fullPathInFiles = trackPath;
                        if (!trackPath.includes('/')) {
                            fullPathInFiles = (m3uDir ? m3uDir + '/' : '') + trackPath;
                        }
                        
                        const file = allFiles[fullPathInFiles] || allFiles[trackPath] || 
                                     Object.values(allFiles).find(f => f.name.toLowerCase() === trackPath.substring(trackPath.lastIndexOf('/') + 1).toLowerCase());
                        
                        if (isMediaFile(file)) { 
                            trackList.push(file);
                        }
                    }

                    updatePlaylistUI();
                    if (trackList.length > 0) playTrack(0);
                };
                reader.readAsText(m3uFile);
            }

            // --- 5. Ch·ª©c nƒÉng Th√™m/S·ª≠a/X√≥a B√†i H√°t ---
            
            function deleteTrack(indexToDelete) {
                if (trackList.length === 0) return;

                trackList.splice(indexToDelete, 1);
                
                if (indexToDelete === currentTrackIndex) {
                    if (trackList.length > 0) {
                        playTrack(indexToDelete % trackList.length); 
                    } else {
                        window.clearAllTracks();
                        return;
                    }
                } else if (indexToDelete < currentTrackIndex) {
                    currentTrackIndex--;
                }
                
                shuffleHistory = shuffleHistory
                                 .filter(index => index !== indexToDelete) 
                                 .map(index => index > indexToDelete ? index - 1 : index); 

                updatePlaylistUI();
                highlightActiveTrack(currentTrackIndex);
                updateControls();
            }

            window.deleteTrack = deleteTrack; 

            function editTrackName(index) {
                const li = playlistElement.querySelector(`li[data-index="${index}"]`);
                if (!li) return;

                const trackNameElement = li.querySelector('.track-name');
                const oldName = trackNameElement.textContent;
                
                const newName = prompt("Nh·∫≠p t√™n m·ªõi cho b√†i h√°t:", oldName);
                if (newName && newName.trim() !== "" && newName !== oldName) {
                    trackNameElement.textContent = newName.trim();
                    
                    if (index === currentTrackIndex) {
                         const isVideo = isMediaFile(trackList[index]) && (trackList[index].type.startsWith('video/') || trackList[index].name.toLowerCase().endsWith('.mp4'));
                         currentTrackDisplay.innerHTML = `**${isVideo ? 'üì∫ ƒêang ph√°t Video:' : 'üé∂ ƒêang ph√°t Nh·∫°c:'}** ${newName.trim()}`;
                    }
                }
            }
            
            window.editTrackName = editTrackName; 


            // --- 6. C·∫≠p nh·∫≠t giao di·ªán Playlist ---
            function updatePlaylistUI() {
                playlistElement.innerHTML = '';
                if (trackList.length === 0) {
                    playlistElement.innerHTML = '<li id="empty-message">Kh√¥ng t√¨m th·∫•y file nh·∫°c/video h·ª£p l·ªá.</li>';
                    updateControls();
                    return;
                }

                trackList.forEach((file, index) => {
                    const li = document.createElement('li');
                    li.dataset.index = index; 
                    
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'track-info';

                    const indexSpan = document.createElement('span');
                    indexSpan.className = 'track-index';
                    indexSpan.textContent = `${index + 1}.`;
                    infoDiv.appendChild(indexSpan);

                    const trackName = document.createElement('span');
                    trackName.className = 'track-name';
                    trackName.textContent = file.webkitRelativePath || file.name;
                    infoDiv.appendChild(trackName);

                    li.appendChild(infoDiv);

                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'track-actions';

                    const editBtn = document.createElement('button');
                    editBtn.textContent = '‚úèÔ∏è';
                    editBtn.title = 'S·ª≠a t√™n b√†i';
                    editBtn.onclick = (e) => {
                        e.stopPropagation(); 
                        editTrackName(index);
                    };
                    actionsDiv.appendChild(editBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = '‚ùå';
                    deleteBtn.title = 'X√≥a b√†i kh·ªèi danh s√°ch';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation(); 
                        deleteTrack(index);
                    };
                    actionsDiv.appendChild(deleteBtn);

                    li.appendChild(actionsDiv);
                    
                    li.addEventListener('click', () => playTrack(index));
                    playlistElement.appendChild(li);
                });
            }

            // --- 7. Main Playback Function ---
            function playTrack(index) {
                if (index >= 0 && index < trackList.length) {
                    
                    if (shuffleHistory[shuffleHistory.length - 1] !== index) {
                         shuffleHistory.push(index);
                    }
                    
                    currentTrackIndex = index;
                    const file = trackList[index];

                    // Ki·ªÉm tra lo·∫°i file ƒë·ªÉ ch·ªçn <audio> ho·∫∑c <video>
                    const isVideo = isMediaFile(file) && (file.type.startsWith('video/') || file.name.toLowerCase().endsWith('.mp4') || file.name.toLowerCase().endsWith('.webm') || file.name.toLowerCase().endsWith('.mov'));
                    const isAudio = !isVideo; 
                    
                    if (mediaPlayer === null || (isVideo && mediaPlayer.tagName !== 'VIDEO') || (isAudio && mediaPlayer.tagName !== 'AUDIO')) {
                        mediaPlayer = createPlayerElement(isAudio);
                    }
                    
                    const fileURL = URL.createObjectURL(file);
                    mediaPlayer.src = fileURL;
                    mediaPlayer.load();
                    mediaPlayer.play().catch(error => {
                        console.error("L·ªói khi c·ªë g·∫Øng ph√°t:", error);
                        playPauseBtn.textContent = '‚ñ∂Ô∏è';
                        currentTrackDisplay.innerHTML = `‚ñ∂Ô∏è ${file.name} - (Click n√∫t Play ƒë·ªÉ b·∫Øt ƒë·∫ßu)`;
                    });

                    const trackNameElement = playlistElement.querySelector(`li[data-index="${index}"] .track-name`);
                    const trackNameDisplay = trackNameElement ? trackNameElement.textContent : (file.webkitRelativePath || file.name);

                    currentTrackDisplay.innerHTML = `**${isVideo ? 'üì∫ ƒêang ph√°t Video:' : 'üé∂ ƒêang ph√°t Nh·∫°c:'}** ${trackNameDisplay}`;
                    highlightActiveTrack(index);
                    updateControls();
                }
            }

            // --- 8. Track Navigation ---

            function getRandomIndex(currentIndex) {
                if (trackList.length <= 1) return 0;
                let newIndex;
                do {
                    newIndex = Math.floor(Math.random() * trackList.length);
                } while (newIndex === currentIndex); 
                return newIndex;
            }

            function playNextTrack() {
                let nextIndex;

                if (isShuffled) {
                    nextIndex = getRandomIndex(currentTrackIndex);
                } else {
                    if (currentTrackIndex < trackList.length - 1) {
                        nextIndex = currentTrackIndex + 1;
                    } else if (repeatMode === 2) {
                        nextIndex = 0; 
                    } else {
                        currentTrackDisplay.innerHTML = "‚úÖ **Danh s√°ch ph√°t ƒë√£ ho√†n th√†nh.**";
                        if (mediaPlayer) mediaPlayer.pause();
                        highlightActiveTrack(-1);
                        updateControls();
                        return;
                    }
                }

                playTrack(nextIndex);
            }

            function playPrevTrack() {
                if (mediaPlayer && mediaPlayer.currentTime > 3) {
                    mediaPlayer.currentTime = 0;
                    return;
                }

                if (shuffleHistory.length > 1) {
                    shuffleHistory.pop(); 
                    const prevIndex = shuffleHistory[shuffleHistory.length - 1]; 
                    
                    currentTrackIndex = prevIndex;
                    const file = trackList[currentTrackIndex];
                    
                    if (mediaPlayer) {
                        const fileURL = URL.createObjectURL(file);
                        mediaPlayer.src = fileURL;
                        mediaPlayer.load();
                        mediaPlayer.play();
                    }

                    const trackNameElement = playlistElement.querySelector(`li[data-index="${currentTrackIndex}"] .track-name`);
                    const trackNameDisplay = trackNameElement ? trackNameElement.textContent : (file.webkitRelativePath || file.name);
                    const isVideo = isMediaFile(file) && (file.type.startsWith('video/') || file.name.toLowerCase().endsWith('.mp4'));
                    currentTrackDisplay.innerHTML = `**${isVideo ? 'üì∫ ƒêang ph√°t Video:' : 'üé∂ ƒêang ph√°t Nh·∫°c:'}** ${trackNameDisplay}`;
                    highlightActiveTrack(currentTrackIndex);
                    updateControls();

                } else if (currentTrackIndex > 0) {
                    playTrack(currentTrackIndex - 1);
                } else if (repeatMode === 2 && trackList.length > 0) {
                    playTrack(trackList.length - 1);
                }
            }

            function updateControls() {
                prevBtn.disabled = trackList.length === 0;
                nextBtn.disabled = trackList.length === 0;
            }
            
            nextBtn.addEventListener('click', playNextTrack);
            prevBtn.addEventListener('click', playPrevTrack);


            // --- 9. Highlight UI ---
            function highlightActiveTrack(index) {
                const items = playlistElement.querySelectorAll('li');
                items.forEach(item => {
                    item.classList.remove('active-track');
                });

                if (index !== -1) {
                    const activeItem = playlistElement.querySelector(`li[data-index="${index}"]`);
                    if (activeItem) {
                        activeItem.classList.add('active-track');
                        activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }
            }
        });
    </script>
</body>
</html>
