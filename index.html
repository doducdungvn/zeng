<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Player To√†n Di·ªán</title>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f9;
        }
        h1, h2 {
            color: #333;
        }
        #fileInput {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            display: block;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 15px;
        }
        /* Playlist Styles */
        #playlist {
            list-style: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
        }
        #playlist li {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
            word-break: break-all;
        }
        #playlist li:last-child {
            border-bottom: none;
        }
        .active-track {
            background-color: #007bff !important;
            color: white;
            font-weight: bold;
        }

        /* Player Controls Styles */
        #playerContainer {
            margin-top: 15px;
        }
        #playerContainer audio, #playerContainer video {
            width: 100%;
            height: auto;
            display: block;
        }
        #controls {
            padding: 15px 0;
            background-color: #e9ecef;
            border-radius: 5px;
            margin-top: 10px;
        }
        #topControls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        #topControls button {
            padding: 10px 15px;
            cursor: pointer;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
        }
        #topControls button:disabled {
            background-color: #999;
        }
        
        /* Volume and Time Controls */
        #volumeAndTimeControls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
        }
        #volumeControls {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #volumeControls button {
            background: none;
            border: none;
            color: #333;
            cursor: pointer;
            font-size: 20px;
            padding: 0;
        }
        #volumeSlider {
            width: 80px;
        }
        #currentVolume {
            width: 35px;
            text-align: right;
            font-size: 0.9em;
        }
        #timeControls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-grow: 1;
            padding: 0 15px;
        }
        #progressBar {
            flex-grow: 1;
            height: 8px;
            cursor: pointer;
        }
        #timeDisplay {
            font-size: 0.9em;
        }
        #currentTrack {
            text-align: center;
            padding: 10px;
            font-style: italic;
            color: #555;
        }
        #footer {
            margin-top: 30px;
            text-align: center;
            font-size: 0.8em;
            color: #777;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <h1>üé¨ Web Player To√†n Di·ªán</h1>

    <input 
        type="file" 
        id="fileInput" 
        accept="audio/*, video/*, .m3u" 
        multiple 
        webkitdirectory
    >

    <hr>

    <h2>Tr√¨nh ph√°t & ƒêi·ªÅu khi·ªÉn</h2>
    <div id="playerContainer">
        </div>
    
    <div id="controls">
        <div id="topControls">
            <button id="prevBtn" disabled>‚èÆÔ∏è</button>
            <button id="playPauseBtn">‚ñ∂Ô∏è</button>
            <button id="nextBtn" disabled>‚è≠Ô∏è</button>
        </div>

        <div id="timeControls">
            <span id="timeDisplay">0:00 / 0:00</span>
            <input type="range" id="progressBar" min="0" max="0" step="0.1" value="0">
        </div>

        <div id="volumeAndTimeControls">
            <div id="volumeControls">
                <button id="muteBtn">üîä</button>
                <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="1">
                <span id="currentVolume">100%</span>
            </div>
        </div>
    </div>
    
    <p id="currentTrack">Ch∆∞a c√≥ b√†i n√†o ƒëang ph√°t.</p>

    <hr>

    <h2>Danh s√°ch ph√°t</h2>
    <ul id="playlist">
        <li id="empty-message">Vui l√≤ng ch·ªçn **th∆∞ m·ª•c** ho·∫∑c **file .m3u** ƒë·ªÉ th√™m v√†o danh s√°ch.</li>
    </ul>

    <div id="footer">
        ¬© 2025 ZENG FINANCE
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UI Elements ---
            const fileInput = document.getElementById('fileInput');
            const playlistElement = document.getElementById('playlist');
            const playerContainer = document.getElementById('playerContainer');
            const currentTrackDisplay = document.getElementById('currentTrack');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const volumeSlider = document.getElementById('volumeSlider');
            const currentVolumeDisplay = document.getElementById('currentVolume');
            const muteBtn = document.getElementById('muteBtn');
            const progressBar = document.getElementById('progressBar');
            const timeDisplay = document.getElementById('timeDisplay');

            // --- State Variables ---
            let allFiles = {}; 
            let trackList = [];
            let currentTrackIndex = -1;
            let currentVolume = 1.0;
            let isMuted = false;
            let mediaPlayer = null;
            let isDraggingSlider = false;

            // --- 0. Helper Functions ---
            function formatTime(seconds) {
                if (isNaN(seconds)) return '0:00';
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.floor(seconds % 60);
                return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
            }

            function updateTimeDisplay(currentTime, duration) {
                timeDisplay.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
            }

            // --- 1. Player Creation & Setup ---
            function createPlayerElement(isAudio = true) {
                playerContainer.innerHTML = ''; 
                const player = isAudio ? document.createElement('audio') : document.createElement('video');
                player.id = 'mediaPlayer';
                player.controls = false; 
                player.autoplay = true;
                player.volume = currentVolume; 
                player.muted = isMuted;
                
                // G·∫Øn s·ª± ki·ªán
                player.addEventListener('ended', playNextTrack);
                player.addEventListener('volumechange', handleVolumeChange);
                player.addEventListener('loadedmetadata', setupProgressBar);
                player.addEventListener('timeupdate', updateProgressBar);
                player.addEventListener('play', () => playPauseBtn.textContent = '‚è∏Ô∏è');
                player.addEventListener('pause', () => playPauseBtn.textContent = '‚ñ∂Ô∏è');
                
                playerContainer.appendChild(player);
                return player;
            }

            // --- 2. Volume and Mute Controls ---
            function handleVolumeChange() {
                if (mediaPlayer) {
                    currentVolume = mediaPlayer.volume;
                    isMuted = mediaPlayer.muted;
                    volumeSlider.value = currentVolume;
                    currentVolumeDisplay.textContent = `${Math.round(currentVolume * 100)}%`;
                    muteBtn.textContent = isMuted ? 'üîá' : 'üîä';
                }
            }

            volumeSlider.addEventListener('input', (event) => {
                currentVolume = parseFloat(event.target.value);
                currentVolumeDisplay.textContent = `${Math.round(currentVolume * 100)}%`;
                if (mediaPlayer) {
                    mediaPlayer.volume = currentVolume;
                    if (currentVolume > 0 && mediaPlayer.muted) {
                        mediaPlayer.muted = false;
                        isMuted = false;
                        muteBtn.textContent = 'üîä';
                    } else if (currentVolume === 0 && !mediaPlayer.muted) {
                        mediaPlayer.muted = true;
                        isMuted = true;
                        muteBtn.textContent = 'üîá';
                    }
                }
            });

            muteBtn.addEventListener('click', () => {
                if (!mediaPlayer) return;
                isMuted = !isMuted;
                mediaPlayer.muted = isMuted;
                muteBtn.textContent = isMuted ? 'üîá' : 'üîä';
            });

            // --- 3. Playback Controls (Play/Pause, Progress Bar) ---
            playPauseBtn.addEventListener('click', () => {
                if (!mediaPlayer) return;
                if (mediaPlayer.paused) {
                    mediaPlayer.play();
                } else {
                    mediaPlayer.pause();
                }
            });

            function setupProgressBar() {
                if (!mediaPlayer) return;
                progressBar.max = mediaPlayer.duration;
                updateTimeDisplay(mediaPlayer.currentTime, mediaPlayer.duration);
            }

            function updateProgressBar() {
                if (!mediaPlayer || isDraggingSlider) return;
                progressBar.value = mediaPlayer.currentTime;
                updateTimeDisplay(mediaPlayer.currentTime, mediaPlayer.duration);
            }

            progressBar.addEventListener('mousedown', () => isDraggingSlider = true);
            progressBar.addEventListener('mouseup', () => {
                isDraggingSlider = false;
                if (mediaPlayer) {
                    mediaPlayer.currentTime = parseFloat(progressBar.value);
                }
            });
            progressBar.addEventListener('input', () => {
                if (mediaPlayer) {
                    updateTimeDisplay(parseFloat(progressBar.value), mediaPlayer.duration);
                }
            });
            
            // --- 4. File/Folder Loading ---
            fileInput.addEventListener('change', (event) => {
                const files = event.target.files;
                if (files.length > 0) {
                    allFiles = {};
                    let m3uFile = null;

                    for (const file of files) {
                        const relativePath = file.webkitRelativePath || file.name;
                        allFiles[relativePath] = file;

                        if (file.name.toLowerCase().endsWith('.m3u')) {
                            if (!m3uFile) m3uFile = file;
                        }
                    }
                    
                    if (m3uFile) {
                        readM3U(m3uFile);
                    } else {
                        trackList = Object.keys(allFiles)
                                        .filter(path => !path.toLowerCase().endsWith('.m3u') && 
                                                        (allFiles[path].type.startsWith('audio/') || allFiles[path].type.startsWith('video/')))
                                        .map(path => allFiles[path]);
                        updatePlaylistUI();
                        if (trackList.length > 0) playTrack(0);
                    }
                }
            });

            function readM3U(m3uFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    const lines = content.split('\n');
                    
                    trackList = [];
                    const m3uDir = m3uFile.webkitRelativePath ? m3uFile.webkitRelativePath.substring(0, m3uFile.webkitRelativePath.lastIndexOf('/')) : '';

                    for (const line of lines) {
                        if (line.trim() === '' || line.startsWith('#')) continue;

                        let trackPath = line.trim();
                        let fullPathInFiles = trackPath;
                        if (!trackPath.includes('/')) {
                            fullPathInFiles = (m3uDir ? m3uDir + '/' : '') + trackPath;
                        }
                        
                        const file = allFiles[fullPathInFiles] || allFiles[trackPath] || 
                                     Object.values(allFiles).find(f => f.name.toLowerCase() === trackPath.substring(trackPath.lastIndexOf('/') + 1).toLowerCase());
                        
                        if (file && (file.type.startsWith('audio/') || file.type.startsWith('video/'))) {
                            trackList.push(file);
                        }
                    }

                    updatePlaylistUI();
                    if (trackList.length > 0) playTrack(0);
                };
                reader.readAsText(m3uFile);
            }

            function updatePlaylistUI() {
                playlistElement.innerHTML = '';
                if (trackList.length === 0) {
                    playlistElement.innerHTML = '<li id="empty-message">Kh√¥ng t√¨m th·∫•y file nh·∫°c/video h·ª£p l·ªá.</li>';
                    updateControls();
                    return;
                }

                trackList.forEach((file, index) => {
                    const li = document.createElement('li');
                    const trackName = file.webkitRelativePath || file.name;
                    li.textContent = trackName; 
                    li.dataset.index = index; 
                    
                    li.addEventListener('click', () => playTrack(index));
                    playlistElement.appendChild(li);
                });
            }

            // --- 5. Main Playback Function ---
            function playTrack(index) {
                if (index >= 0 && index < trackList.length) {
                    currentTrackIndex = index;
                    const file = trackList[index];

                    const isVideo = file.type.startsWith('video/');
                    const isAudio = file.type.startsWith('audio/');
                    
                    if (mediaPlayer === null || (isVideo && mediaPlayer.tagName !== 'VIDEO') || (isAudio && mediaPlayer.tagName !== 'AUDIO')) {
                        mediaPlayer = createPlayerElement(isAudio);
                    }
                    
                    const fileURL = URL.createObjectURL(file);
                    mediaPlayer.src = fileURL;
                    mediaPlayer.load();
                    mediaPlayer.play().catch(error => {
                        console.error("L·ªói khi c·ªë g·∫Øng ph√°t:", error);
                        playPauseBtn.textContent = '‚ñ∂Ô∏è';
                        currentTrackDisplay.innerHTML = `‚ñ∂Ô∏è ${file.name} - (Click n√∫t Play ƒë·ªÉ b·∫Øt ƒë·∫ßu)`;
                    });

                    const trackNameDisplay = file.webkitRelativePath || file.name;
                    currentTrackDisplay.innerHTML = `**${isVideo ? 'üì∫ ƒêang ph√°t Video:' : 'üé∂ ƒêang ph√°t Nh·∫°c:'}** ${trackNameDisplay}`;
                    highlightActiveTrack(index);
                    updateControls();
                }
            }

            // --- 6. Track Navigation ---
            function playNextTrack() {
                if (currentTrackIndex < trackList.length - 1) {
                    playTrack(currentTrackIndex + 1);
                } else {
                    currentTrackDisplay.innerHTML = "‚úÖ **Danh s√°ch ph√°t ƒë√£ ho√†n th√†nh.**";
                    mediaPlayer.pause();
                    highlightActiveTrack(-1);
                    updateControls();
                }
            }

            function playPrevTrack() {
                if (mediaPlayer && mediaPlayer.currentTime > 3) {
                    mediaPlayer.currentTime = 0;
                } else if (currentTrackIndex > 0) {
                    playTrack(currentTrackIndex - 1);
                }
            }

            function updateControls() {
                prevBtn.disabled = currentTrackIndex <= 0;
                nextBtn.disabled = currentTrackIndex >= trackList.length - 1 || trackList.length === 0;
            }
            
            nextBtn.addEventListener('click', playNextTrack);
            prevBtn.addEventListener('click', playPrevTrack);

            // --- 7. Highlight UI ---
            function highlightActiveTrack(index) {
                const items = playlistElement.querySelectorAll('li');
                items.forEach(item => {
                    item.classList.remove('active-track');
                });

                if (index !== -1) {
                    const activeItem = playlistElement.querySelector(`li[data-index="${index}"]`);
                    if (activeItem) {
                        activeItem.classList.add('active-track');
                        activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }
            }
        });
    </script>
</body>
</html>
